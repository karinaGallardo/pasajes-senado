{{ define "viatico/modal_create" }}
<div x-data="viaticoCalculator()" x-init="init()" x-show="open" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <!-- Backdrop -->
  <div
    x-show="open"
    x-transition:enter="ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-neutral-900/60 backdrop-blur-sm transition-opacity"></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div
        x-show="open"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-4xl border border-neutral-200">
        <form action="/solicitudes/{{ .Solicitud.ID }}/viaticos" method="POST" @submit="loading = true">
          <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />

          <!-- Header -->
          <div class="px-8 py-6 border-b border-neutral-100 flex items-center justify-between bg-neutral-50/30">
            <div class="flex items-center gap-4">
              <div class="h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
                <i class="ph ph-calculator text-2xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-black text-neutral-800 uppercase tracking-tight" id="modal-title">Asignación de Viáticos</h3>
                <p class="text-xs text-neutral-400 font-bold uppercase tracking-widest mt-0.5">Comisión Oficial #{{ .Solicitud.Codigo }}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button
                type="submit"
                :disabled="loading"
                class="px-5 py-2 bg-primary text-white rounded-md font-bold uppercase tracking-widest text-[10px] shadow-lg shadow-primary/20 hover:bg-primary-600 transition-all disabled:opacity-50">
                <span x-show="!loading">Registrar</span>
                <span x-show="loading">...</span>
              </button>
              <button
                type="button"
                @click="open = false"
                class="px-4 py-2 rounded-md border border-neutral-200 font-bold uppercase tracking-widest text-[10px] text-neutral-500 hover:bg-white transition-all">
                Cancelar
              </button>
            </div>
          </div>

          <div class="p-8 pt-2 space-y-2 max-h-[70vh] overflow-y-auto">
            <!-- Info Solicitud Summary -->
            <div class="bg-neutral-50 rounded-2xl p-6 pt-0 border border-neutral-200 grid grid-cols-2 md:grid-cols-4 gap-6">
              <div class="space-y-1">
                <span class="text-[10px] font-black text-neutral-400 uppercase tracking-tight">Funcionario</span>
                <span class="block text-xs font-bold text-neutral-800">{{ .Solicitud.Usuario.GetNombreCompleto }}</span>
              </div>
              <div class="space-y-1">
                <span class="text-[10px] font-black text-neutral-400 uppercase tracking-tight">Destino</span>
                <span class="block text-xs font-bold text-neutral-800">{{ .Solicitud.GetDestinoCiudad }}</span>
              </div>
              <div class="space-y-1">
                <span class="text-[10px] font-black text-neutral-400 uppercase tracking-tight">Salida</span>
                <span class="block text-xs font-bold text-neutral-800">
                  {{ if .Solicitud.GetFechaIda }}{{ .Solicitud.GetFechaIda.Format "02/01/06 15:04" }}{{ else }} - {{ end }}
                </span>
              </div>
              <div class="space-y-1">
                <span class="text-[10px] font-black text-neutral-400 uppercase tracking-tight">Retorno</span>
                <span class="block text-xs font-bold text-neutral-800">
                  {{ if .Solicitud.GetFechaVuelta }}{{ .Solicitud.GetFechaVuelta.Format "02/01/06" }}{{ else }} - {{ end }}
                </span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-4">
              <!-- Fecha Desde / Hasta -->
              <div class="space-y-2">
                <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Fecha Desde</label>
                <div class="relative">
                  <i class="ph ph-calendar-blank absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 text-lg"></i>
                  <input
                    type="date"
                    name="fecha_desde"
                    required
                    value='{{ if .Solicitud.GetFechaIda }}{{ .Solicitud.GetFechaIda.Format "2006-01-02" }}{{ end }}'
                    class="w-full pl-12 pr-4 py-2.5 bg-neutral-50 border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-neutral-700 text-sm" />
                </div>
              </div>

              <div class="space-y-2">
                <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Fecha Hasta</label>
                <div class="relative">
                  <i class="ph ph-calendar-check absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 text-lg"></i>
                  <input
                    type="date"
                    name="fecha_hasta"
                    required
                    value='{{ if .Solicitud.GetFechaVuelta }}{{ .Solicitud.GetFechaVuelta.Format "2006-01-02" }}{{ end }}'
                    class="w-full pl-12 pr-4 py-2.5 bg-neutral-50 border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-neutral-700 text-sm" />
                </div>
              </div>

              <!-- Zona/Grupo y Categoria -->
              <div class="space-y-2">
                <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Grupo / Zona de Destino</label>
                <div class="relative">
                  <i class="ph ph-map-pin absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 text-lg"></i>
                  <select
                    x-model="selectedZona"
                    class="w-full pl-12 pr-4 py-2.5 bg-neutral-50 border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-neutral-700 appearance-none cursor-pointer text-sm">
                    <option value="">Seleccione una zona...</option>
                    {{ range .Zonas }}
                    <option value="{{ .ID }}">{{ .Nombre }}</option>
                    {{ end }}
                  </select>
                </div>
              </div>

              <div class="space-y-2">
                <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Escala Diaria (Categoría)</label>
                <div class="relative">
                  <i class="ph ph-list-numbers absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 text-lg"></i>
                  <select
                    name="monto_dia"
                    x-model="selectedMonto"
                    :disabled="!selectedZona"
                    required
                    class="w-full pl-12 pr-10 py-2.5 bg-neutral-50 border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-neutral-700 appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <option value="">Seleccione categoría...</option>
                    <template x-for="cat in filteredCategorias" :key="cat.ID">
                      <option :value="cat.Monto" x-text="`${cat.Nombre} (${cat.Moneda} ${cat.Monto})`"></option>
                    </template>
                  </select>
                  <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                    <i class="ph ph-caret-down text-neutral-400"></i>
                  </div>
                </div>
              </div>

              <!-- Dias y Porcentaje -->
              <div class="space-y-2">
                <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Número de Días</label>
                <div class="relative">
                  <i class="ph ph-clock-counter-clockwise absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 text-lg"></i>
                  <input
                    type="number"
                    step="0.5"
                    name="dias"
                    x-model="dias"
                    required
                    class="w-full pl-12 pr-4 py-2.5 bg-neutral-50 border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-neutral-700 text-sm" />
                </div>
              </div>

              <div class="space-y-2">
                <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Porcentaje de Reconocimiento</label>
                <div class="relative">
                  <i class="ph ph-percent absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 text-lg"></i>
                  <select
                    name="porcentaje"
                    x-model="porcentaje"
                    class="w-full pl-12 pr-10 py-2.5 bg-neutral-50 border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-neutral-700 appearance-none cursor-pointer text-sm">
                    <option value="100">100% - Viático Completo</option>
                    <option value="70">70% - Hospedaje Cubierto</option>
                    <option value="40">40% - Sin Pernocte</option>
                    <option value="25">25% - Hospedaje y Alimentación Cubiertos</option>
                  </select>
                  <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">
                    <i class="ph ph-caret-down text-neutral-400"></i>
                  </div>
                </div>
              </div>

              <div class="md:col-span-2 space-y-2">
                <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Lugar Detallado / Itinerario</label>
                <div class="relative">
                  <i class="ph ph-map-trifold absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 text-lg"></i>
                  <input
                    type="text"
                    name="lugar"
                    required
                    value="{{ .Solicitud.GetDestinoCiudad }}"
                    class="w-full pl-12 pr-4 py-2.5 bg-neutral-50 border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-neutral-700 text-sm" />
                </div>
              </div>

              <!-- Gasto rep -->
              <div class="md:col-span-2 bg-neutral-50 rounded-2xl p-4 border border-neutral-100">
                <label class="flex items-center gap-4 cursor-pointer group">
                  <input
                    type="checkbox"
                    name="gastos_rep"
                    x-model="gastosRep"
                    class="peer h-5 w-5 rounded border-neutral-300 text-primary focus:ring-primary/20 transition-all cursor-pointer" />
                  <div>
                    <span class="block text-xs font-black text-neutral-700 uppercase tracking-tight group-hover:text-primary transition-colors">
                      ¿Incluir Gastos de Representación?
                    </span>
                    <span class="block text-[10px] text-neutral-400 font-bold">Adiciona un 25% extra al total.</span>
                  </div>
                </label>
              </div>
            </div>

            <!-- Resumen Totales -->
            <div class="bg-neutral-900 rounded-2xl p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="space-y-1">
                <span class="text-[10px] font-black text-neutral-400 uppercase tracking-widest block">Subtotal</span>
                <div class="flex items-baseline gap-1.5">
                  <span class="text-[10px] font-bold text-neutral-500">Bs</span>
                  <span class="text-xl font-black text-white" x-text="formatNumber(total)">0.00</span>
                </div>
              </div>
              <div class="space-y-1">
                <span class="text-[10px] font-black text-neutral-400 uppercase tracking-widest block">RC-IVA (13%)</span>
                <div class="flex items-baseline gap-1.5">
                  <span class="text-[10px] font-bold text-neutral-500">Bs</span>
                  <span class="text-xl font-black text-danger-400" x-text="formatNumber(rcIva)">0.00</span>
                </div>
              </div>
              <div class="space-y-1 border-l border-white/10 pl-6">
                <span class="text-[10px] font-black text-primary-300 uppercase tracking-widest block">Líquido Pagable</span>
                <div class="flex items-baseline gap-1.5">
                  <span class="text-[10px] font-bold text-primary-400">Bs</span>
                  <span class="text-2xl font-black text-white" x-text="formatNumber(liquido)">0.00</span>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function viaticoCalculator() {
      return {
        open: true,
        loading: false,
        allCategorias: [
          {{ range .Categorias }}
          {
            ID: "{{ .ID }}",
            Nombre: "{{ .Nombre }}",
            Monto: {{ .Monto }},
            Moneda: "{{ .Moneda }}",
            ZonaViaticoID: "{{ .ZonaViaticoID }}"
          },
          {{ end }}
        ],
        selectedZona: "",
        selectedMonto: "",
        dias: {{ .DefaultDias }},
        porcentaje: 100,
        gastosRep: false,
        total: 0,
        rcIva: 0,
        liquido: 0,

        get filteredCategorias() {
          if (!this.selectedZona) return [];
          return this.allCategorias.filter((c) => c.ZonaViaticoID === this.selectedZona);
        },

        init() {
          this.$watch("selectedZona", () => {
            this.selectedMonto = "";
            this.calculate();
          });
          this.$watch("selectedMonto", () => this.calculate());
          this.$watch("dias", () => this.calculate());
          this.$watch("porcentaje", () => this.calculate());
          this.$watch("gastosRep", () => this.calculate());
          this.calculate();
        },

        calculate() {
          const monto = parseFloat(this.selectedMonto) || 0;
          const dias = parseFloat(this.dias) || 0;
          const perc = parseInt(this.porcentaje) || 0;

          let baseTotal = monto * (perc / 100.0) * dias;
          if (this.gastosRep) {
            baseTotal += baseTotal * 0.25;
          }

          this.total = baseTotal;
          this.rcIva = baseTotal * 0.13;
          this.liquido = baseTotal - this.rcIva;
        },

        formatNumber(n) {
          return new Intl.NumberFormat("es-BO", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(n);
        },
      };
    }
  </script>
</div>
{{ end }}
