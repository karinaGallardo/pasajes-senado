{{ define "viatico/create" }} {{ template "layout_start" . }}

<div class="max-w-4xl mx-auto mt-8 px-4 pb-12">
  <div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-primary-800">Asignar Viáticos</h1>
    <a href="/solicitudes/{{ .Solicitud.ID }}" class="text-neutral-600 hover:text-neutral-800">&larr; Volver a Solicitud</a>
  </div>

  <!-- Info Solicitud -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4 border-b pb-2">Información del Viaje</h2>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <span class="text-sm text-neutral-500 block">Funcionario</span>
        <span class="font-medium">{{ .Solicitud.Usuario.GetNombreCompleto }}</span>
      </div>
      <div>
        <span class="text-sm text-neutral-500 block">Destino</span>
        <span class="font-medium">{{ .Solicitud.GetDestinoCiudad }}</span>
      </div>
      <div>
        <span class="text-sm text-neutral-500 block">Fecha Salida</span>
        <span class="font-medium">{{ if .Solicitud.GetFechaIda }}{{ .Solicitud.GetFechaIda.Format "02/01/2006 15:04" }}{{ else }} - {{ end }}</span>
      </div>
      <div>
        <span class="text-sm text-neutral-500 block">Fecha Retorno(Est.)</span>
        <span class="font-medium">{{ if .Solicitud.GetFechaVuelta }} {{ .Solicitud.GetFechaVuelta.Format "02/01/2006" }} {{ else }} (Solo Ida) {{ end }}</span>
      </div>
    </div>
  </div>

  <form action="/solicitudes/{{ .Solicitud.ID }}/viaticos" method="POST" class="bg-white rounded-lg shadow overflow-hidden">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <div class="p-6">
      <h3 class="text-lg font-semibold mb-4 text-primary-700">Cálculo de Viático</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Fecha Desde / Hasta -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Fecha Desde</label>
          <input
            type="date"
            name="fecha_desde"
            required
            value='{{ if .Solicitud.GetFechaIda }}{{ .Solicitud.GetFechaIda.Format "2006-01-02" }}{{ end }}'
            class="w-full border-neutral-300 rounded-md shadow-sm focus:border-primary-500 focus:ring-primary-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Fecha Hasta</label>
          <input
            type="date"
            name="fecha_hasta"
            required
            value='{{ if .Solicitud.GetFechaVuelta }}{{ .Solicitud.GetFechaVuelta.Format "2006-01-02" }}{{ end }}'
            class="w-full border-neutral-300 rounded-md shadow-sm focus:border-primary-500 focus:ring-primary-500" />
        </div>

        <!-- Dias y Monto -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Días</label>
          <input
            type="number"
            step="0.5"
            name="dias"
            id="dias"
            required
            value="{{ .DefaultDias }}"
            class="w-full border-neutral-300 rounded-md shadow-sm focus:border-primary-500 focus:ring-primary-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Escala Diaria</label>
          <select name="monto_dia" id="monto_dia" class="w-full border-neutral-300 rounded-md shadow-sm focus:border-primary-500 focus:ring-primary-500">
            {{ range .Categorias }}
            <option value="{{ .Monto }}">{{ .Nombre }} ({{ .Moneda }} {{ .Monto }}) - {{ .Ubicacion }}</option>
            {{ end }}
          </select>
        </div>

        <!-- Porcentaje y Lugar -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Porcentaje</label>
          <select name="porcentaje" id="porcentaje" class="w-full border-neutral-300 rounded-md shadow-sm focus:border-primary-500 focus:ring-primary-500">
            <option value="100">100% (Viático Completo)</option>
            <option value="70">70% (Hospedaje Pagado)</option>
            <option value="40">40% (Sin Pernocte)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-1">Lugar / Itinerario</label>
          <input
            type="text"
            name="lugar"
            required
            value="{{ .Solicitud.GetDestinoCiudad }}"
            class="w-full border-neutral-300 rounded-md shadow-sm focus:border-primary-500 focus:ring-primary-500" />
        </div>

        <!-- Opciones Extra -->
        <div class="md:col-span-2 flex items-center space-x-4 mt-2 p-4 bg-neutral-50 rounded">
          <div class="flex items-center">
            <input type="checkbox" name="gastos_rep" id="gastos_rep" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-neutral-300 rounded" />
            <label for="gastos_rep" class="ml-2 block text-sm text-neutral-900 font-medium">Incluir Gastos de Representación (25%)</label>
          </div>
        </div>
      </div>

      <!-- Previsualizacion Calculos (JS Simple) -->
      <div class="mt-8 bg-primary-50 p-4 rounded border border-primary-200">
        <h4 class="text-sm font-bold text-primary-800 uppercase mb-2">Resumen Estimado</h4>
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <span class="block text-xs text-neutral-500">Total Viático</span>
            <span class="block text-xl font-bold text-neutral-800" id="preview_total">0.00</span>
          </div>
          <div>
            <span class="block text-xs text-neutral-500">Retención RC-IVA (13%)</span>
            <span class="block text-xl font-bold text-danger-600" id="preview_rciva">0.00</span>
          </div>
          <div>
            <span class="block text-xs text-neutral-500">Líquido Pagable</span>
            <span class="block text-2xl font-bold text-success-700" id="preview_liquido">0.00</span>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-neutral-50 px-6 py-4 flex justify-end">
      <button type="submit" class="bg-primary-700 text-white px-4 py-2 rounded-md hover:bg-primary-800 shadow-sm font-medium flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        Registrar Asignación
      </button>
    </div>
  </form>
</div>

<script>
  (function () {
    const diasInput = document.getElementById("dias");
    const montoSelect = document.getElementById("monto_dia");
    const percentSelect = document.getElementById("porcentaje");
    const gastosCheck = document.getElementById("gastos_rep");

    function calculate() {
      const dias = parseFloat(diasInput.value) || 0;
      const monto = parseFloat(montoSelect.value) || 0;
      const percent = parseInt(percentSelect.value) || 0;

      let total = monto * (percent / 100.0) * dias;

      if (gastosCheck.checked) {
        total += total * 0.25;
      }

      const rcIva = total * 0.13;
      const liquido = total - rcIva;

      document.getElementById("preview_total").innerText = total.toFixed(2);
      document.getElementById("preview_rciva").innerText = rcIva.toFixed(2);
      document.getElementById("preview_liquido").innerText = liquido.toFixed(2);
    }

    if (diasInput) {
      [diasInput, montoSelect, percentSelect, gastosCheck].forEach((el) => {
        el.addEventListener("change", calculate);
        el.addEventListener("input", calculate);
      });
      calculate();
    }
  })();
</script>

{{ template "layout_end" . }} {{ end }}
