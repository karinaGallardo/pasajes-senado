{{ define "solicitud/create" }} {{ template "layout_start" . }}

<div
  class="max-w-5xl mx-auto space-y-6"
  x-data="{
    showForm: false,
    tipo: 'IDA_VUELTA',
    origen: '{{ .TargetUser.GetOrigenIATA }}',
    userOrigenCode: '{{ .TargetUser.GetOrigenIATA }}',
    userOrigenName: '{{ if .TargetUser.Origen }}{{ .TargetUser.Origen.Ciudad }}{{ else }}Ciudad No Configurada{{ end }}',
    targetShortName: '{{ .TargetUser.Firstname }}',
    lpbCode: 'LPB',
    lpbName: 'La Paz - El Alto',
    isLocked: true,
    itemSelected: '',

    activeTab: 'IDA',
    isSubmitting: false,

    minDate: '',
    maxDate: '',
    weekDays: [],

    selectedDaySalida: '',
    selectedTimeSalida: '08:00',

    isEdit: false,
    editId: '',
    motivo: '',
    aerolinea: '',
    tipoItinerario: 'SOLO_IDA',
    vueltaPorConfirmar: false,
    selectedDayRetorno: '',
    selectedTimeRetorno: '18:00',
    tipoItinerarioId: '',
    itinerarioIda: '{{ .ItinerarioIdaID }}',
    itinerarioVuelta: '{{ .ItinerarioVueltaID }}',

    resetForm() {
        this.isEdit = false;
        this.editId = '';
        this.motivo = '';
        this.aerolinea = '';
        this.tipoItinerarioId = this.itinerarioIda;
        this.showForm = false;
    },

    initSelection(min, max) {
        this.minDate = min;
        this.maxDate = max;
        this.generateWeek(min);

        this.selectedDaySalida = min;
    },

    selectItem(itemId, min, max, tab) {
        this.resetForm();
        this.itemSelected = itemId;
        this.activeTab = tab;
        this.showForm = true;
        this.tipo = 'SOLO_IDA';

        if (tab === 'VUELTA') {
          this.origen = 'LPB';
          this.tipoItinerarioId = this.itinerarioVuelta;
        } else {
          this.tipoItinerarioId = this.itinerarioIda;
          if (this.userOrigenCode) {
            this.origen = this.userOrigenCode;
          }
        }

        this.initSelection(min, max);

        setTimeout(() => {
          const formElement = document.getElementById('main-form-container');
          if (formElement) formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    },

    loadEdit(itemId, min, max, tab, solId, origen, fSalidaStr, motivoStr, aerolineaStr, itinId) {
        this.resetForm();
        this.isEdit = true;
        this.editId = solId;
        this.itemSelected = itemId;
        this.activeTab = tab;
        this.showForm = true;
        this.tipo = 'SOLO_IDA';

        this.origen = origen;
        this.motivo = motivoStr;
        this.aerolinea = aerolineaStr;
        this.tipoItinerarioId = itinId;

        this.initSelection(min, max);

        if (fSalidaStr) {
             const parts = fSalidaStr.split('T');
             this.selectedDaySalida = parts[0];
             if (parts.length > 1) {
                this.selectedTimeSalida = parts[1].substring(0, 5);
             }
        }

        setTimeout(() => {
          const formElement = document.getElementById('main-form-container');
          if (formElement) formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    },

    init() {
        this.checkAutoOpen();
    },

    checkAutoOpen() {
        const urlParams = new URLSearchParams(window.location.search);
        const vID = urlParams.get('auto_item');
        const tab = urlParams.get('auto_tab');

        if (vID && tab) {
            this.$nextTick(() => {
                const btn = document.getElementById(`btn-${tab}-${vID}`);
                if (btn) {
                    btn.click();
                }
            });

            const newUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
            window.history.replaceState({path:newUrl}, '', newUrl);
        }
    },

    generateWeek(startStr) {
      const days = [];
      const start = new Date(startStr + 'T12:00:00');
      const names = ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'];
      const fullNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

      for (let i = 0; i < 7; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const dateStr = `${yyyy}-${mm}-${dd}`;

        days.push({
            date: dateStr,
            name: names[d.getDay()],
            fullName: fullNames[d.getDay()],
            dayNum: dd
        });
      }
      this.weekDays = days;
    }
}"
  x-effect="
    if (tipo === 'IDA_VUELTA') {
        isLocked = true;
        if (userOrigenCode !== 'LPB' && userOrigenCode !== '') {
            origen = userOrigenCode;
        }
    } else {
        isLocked = false;
    }
">
  <!-- HEADER -->
  <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-neutral-200">
    <div>
      <h2 class="text-xl font-bold text-neutral-800 tracking-tight">Nueva Solicitud</h2>
      <p class="text-sm text-neutral-500">Siga los pasos para emitir su pasaje</p>
    </div>
    <div class="flex items-center space-x-3">
      <a
        href="/solicitudes"
        class="inline-flex items-center px-4 py-2 border border-neutral-300 rounded-md text-sm font-medium text-neutral-700 bg-white hover:bg-neutral-50 transition-colors">
        Cancelar
      </a>
    </div>
  </div>

  {{ if .AlertaOrigen }}
  <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-md">
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="ph ph-warning text-xl text-amber-400"></i>
      </div>
      <div class="ml-3">
        <p class="text-sm text-amber-700 font-medium">
          {{ .AlertaOrigen }}
          <a href="{{ if eq .AuthUser.ID .TargetUser.ID }}/perfil{{ else }}/usuarios/{{ .TargetUser.ID }}/editar{{ end }}" class="font-bold underline hover:text-amber-800 ml-1">
            Configurar ahora
          </a>
        </p>
      </div>
    </div>
  </div>
  {{ end }}

  <!-- PASO 1: SELECCIÓN DE CUPO -->
  <div class="bg-white rounded-lg shadow-sm border border-neutral-200 overflow-hidden">
    <div class="p-6 border-b border-neutral-100 flex justify-between items-center bg-neutral-50/50">
      <div>
        <h3 class="text-xs font-bold text-secondary uppercase tracking-wider mb-1">Paso 1: Selección de Cupo</h3>
        <p class="text-sm font-medium text-neutral-600">Disponibilidad del Mes</p>
      </div>
      <button x-show="showForm" @click="showForm = false" class="text-xs font-bold text-primary hover:underline flex items-center">
        <i class="ph ph-caret-up text-lg mr-1"></i>
        Cambiar Cupo de Pasajes
      </button>
    </div>

    <div class="p-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {{ range .Items }}
        <div
          class="relative border rounded-xl p-5 transition-all duration-200 flex flex-col items-center text-center space-y-3
            {{ if eq .EstadoCupoDerechoCodigo `DISPONIBLE` }}
              bg-white border-neutral-200 cursor-pointer hover:border-secondary hover:shadow-md
            {{ else }}
              bg-neutral-50 border-neutral-100 opacity-75
            {{ end }}"
          :class="{
              'border-secondary ring-2 ring-secondary/10 bg-primary-50/10 shadow-sm': itemSelected === '{{ .ID }}' 
          }"
          @click="
            {{ if eq .EstadoCupoDerechoCodigo `DISPONIBLE` }}
              selectItem('{{ .ID }}', '{{ if .FechaDesde }}{{ .FechaDesde.Format `2006-01-02` }}{{ end }}', '{{ if .FechaHasta }}{{ .FechaHasta.Format `2006-01-02` }}{{ end }}', 'IDA');
            {{ end }}
          ">
          <div class="absolute top-2 right-2" x-show="itemSelected === '{{ .ID }}'">
            <i class="ph ph-check-circle text-2xl text-secondary"></i>
          </div>

          <span class="px-2 py-0.5 rounded bg-neutral-100 text-[10px] font-bold uppercase tracking-tight text-neutral-500">{{ .Semana }}</span>

          <div class="py-1">
            <div class="flex items-baseline justify-center space-x-1">
              <span class="text-2xl font-bold text-neutral-900">{{ if .FechaDesde }}{{ .FechaDesde.Format "02" }}{{ end }}</span>
              <span class="text-xs font-medium text-neutral-400 uppercase">al</span>
              <span class="text-2xl font-bold text-neutral-900">{{ if .FechaHasta }}{{ .FechaHasta.Format "02" }}{{ end }}</span>
            </div>
            <p class="text-[10px] text-neutral-400 font-medium mt-0.5 lowercase tracking-wide">{{ if .FechaHasta }}{{ .FechaHasta.Format "Enero 2006" }}{{ end }}</p>
          </div>

          <div class="w-full h-px bg-neutral-100"></div>

          <!-- Status badge -->
          <span
            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase 
            {{ if eq .EstadoCupoDerechoCodigo `DISPONIBLE` }} bg-success-100 text-success-700 
            {{ else if eq .EstadoCupoDerechoCodigo `RESERVADO` }} bg-amber-100 text-amber-700 
            {{ else }} bg-primary-100 text-primary-700 {{ end }}">
            {{ .EstadoCupoDerechoCodigo }}
          </span>

          <!-- Quick Actions -->
          <div class="w-full pt-3 flex flex-wrap justify-center gap-1.5 border-t border-neutral-50">
            <!-- Ida: Show Create IF NO Solicitud Ida -->
            {{ $solIda := .GetSolicitudIda }} {{ if not $solIda }}
            <button
              type="button"
              id="btn-IDA-{{ .ID }}"
              @click.stop="selectItem('{{ .ID }}', '{{ if .FechaDesde }}{{ .FechaDesde.Format `2006-01-02` }}{{ end }}', '{{ if .FechaHasta }}{{ .FechaHasta.Format `2006-01-02` }}{{ end }}', 'IDA')"
              class="group/btn relative px-2.5 py-1 rounded text-[9px] font-bold uppercase border transition-all bg-white text-neutral-500 border-neutral-200 hover:border-secondary hover:text-secondary">
              Crear Ida
            </button>
            {{ else }}
            <!-- Show Status/Link IF Solicitud Ida Exists -->
            {{ $st := $solIda.GetEstado }} {{ if eq $st "SOLICITADO" }}
            <button
              type="button"
              id="btn-IDA-{{ .ID }}"
              data-motivo="{{ $solIda.Motivo }}"
              @click.stop="loadEdit(
                  '{{ .ID }}', 
                  '{{ if .FechaDesde }}{{ .FechaDesde.Format `2006-01-02` }}{{ end }}', 
                  '{{ if .FechaHasta }}{{ .FechaHasta.Format `2006-01-02` }}{{ end }}', 
                  'IDA',
                  '{{ $solIda.ID }}',
                  '{{ $solIda.OrigenIATA }}',
                  '{{ if $solIda.FechaIda }}{{ $solIda.FechaIda.Format `2006-01-02T15:04` }}{{ end }}',
                  $el.dataset.motivo,
                  '{{ $solIda.AerolineaSugerida }}',
                  '{{ $solIda.TipoItinerarioCodigo }}'
                )"
              class="group/btn relative px-2.5 py-1 rounded text-[9px] font-bold uppercase border transition-all bg-amber-50 text-amber-700 border-amber-100 hover:bg-amber-100">
              Editar Ida
            </button>
            {{ else }}
            <a
              href="/solicitudes/{{ $solIda.ID }}"
              class="group/btn relative px-2.5 py-1 rounded text-[9px] font-bold uppercase border transition-all
              {{ if eq $st `APROBADO` }} bg-primary-50 text-primary-700 border-primary-100 hover:bg-primary-100
              {{ else if eq $st `FINALIZADO` }} bg-success-50 text-success-700 border-success-100 hover:bg-success-100
              {{ else }} bg-neutral-50 text-neutral-700 border-neutral-100 {{ end }}">
              Ver Ida
            </a>
            {{ end }} {{ end }}

            <!-- Vuelta: Show Create IF NO Solicitud Vuelta -->
            {{ $solVuelta := .GetSolicitudVuelta }} {{ if not $solVuelta }}
            <button
              type="button"
              id="btn-VUELTA-{{ .ID }}"
              @click.stop="selectItem('{{ .ID }}', '{{ if .FechaDesde }}{{ .FechaDesde.Format `2006-01-02` }}{{ end }}', '{{ if .FechaHasta }}{{ .FechaHasta.Format `2006-01-02` }}{{ end }}', 'VUELTA')"
              class="group/btn relative px-2.5 py-1 rounded text-[9px] font-bold uppercase border transition-all bg-white text-neutral-500 border-neutral-200 hover:border-secondary hover:text-secondary">
              Crear Vuelta
            </button>
            {{ else }}
            <!-- Show Status/Link IF Solicitud Vuelta Exists -->
            {{ $stV := $solVuelta.GetEstado }} {{ if eq $stV "SOLICITADO" }}
            <button
              type="button"
              id="btn-VUELTA-{{ .ID }}"
              data-motivo="{{ $solVuelta.Motivo }}"
              @click.stop="loadEdit(
                  '{{ .ID }}', 
                  '{{ if .FechaDesde }}{{ .FechaDesde.Format `2006-01-02` }}{{ end }}', 
                  '{{ if .FechaHasta }}{{ .FechaHasta.Format `2006-01-02` }}{{ end }}', 
                  'VUELTA',
                  '{{ $solVuelta.ID }}',
                  '{{ $solVuelta.OrigenIATA }}',
                  '{{ if $solVuelta.FechaVuelta }}{{ $solVuelta.FechaVuelta.Format `2006-01-02T15:04` }}{{ else if $solVuelta.FechaIda }}{{ $solVuelta.FechaIda.Format `2006-01-02T15:04` }}{{ end }}',
                  $el.dataset.motivo,
                  '{{ $solVuelta.AerolineaSugerida }}',
                  '{{ $solVuelta.TipoItinerarioCodigo }}'
                )"
              class="group/btn relative px-2.5 py-1 rounded text-[9px] font-bold uppercase border transition-all bg-amber-50 text-amber-700 border-amber-100 hover:bg-amber-100">
              Editar Vuelta
            </button>
            {{ else }}
            <a
              href="/solicitudes/{{ $solVuelta.ID }}"
              class="group/btn relative px-2.5 py-1 rounded text-[9px] font-bold uppercase border transition-all
              {{ if eq $stV `APROBADO` }} bg-primary-50 text-primary-700 border-primary-100 hover:bg-primary-100
              {{ else if eq $stV `FINALIZADO` }} bg-success-50 text-success-700 border-success-100 hover:bg-success-100
              {{ else }} bg-neutral-50 text-neutral-700 border-neutral-100 {{ end }}">
              Ver Vuelta
            </a>
            {{ end }} {{ end }}

            <!-- Descargo logic -->
            {{ $descargo := .GetDescargo }} {{ $anyTravel := or $solIda $solVuelta }}
            <button
              type="button"
              @click.stop="selectItem('{{ .ID }}', '{{ if .FechaDesde }}{{ .FechaDesde.Format `2006-01-02` }}{{ end }}', '{{ if .FechaHasta }}{{ .FechaHasta.Format `2006-01-02` }}{{ end }}', 'DESCARGO')"
              class="group/btn relative px-2.5 py-1 rounded text-[9px] font-bold uppercase border transition-all
              {{ if $anyTravel }}
                {{ if not $descargo }} bg-danger-50 text-danger-700 border-danger-100 
                {{ else if eq $descargo.Estado `APROBADO` }} bg-success-50 text-success-700 border-success-100
                {{ else }} bg-primary/5 text-primary border-primary/10 {{ end }}
              {{ else }}
                bg-neutral-50 text-neutral-300 border-neutral-100 cursor-not-allowed
              {{ end }}">
              Descargo
            </button>
          </div>
        </div>
        {{ end }}
      </div>
    </div>
  </div>

  <!-- COMPONENTES DE FORMULARIO -->
  <div id="main-form-container" class="transition-all duration-500">{{ template "solicitud/components/form_pasaje" . }} {{ template "solicitud/components/form_descargo" . }}</div>
</div>

{{ template "layout_end" . }} {{ end }}
