{{ define "solicitud/components/modal_editar_pasaje" }}
<div
  x-data="{
      open: true,
      id: '{{ .Pasaje.ID }}',
      ruta: '{{ .Pasaje.Ruta }}',
      agencia_id: '{{ if .Pasaje.AgenciaID }}{{ .Pasaje.AgenciaID }}{{ end }}',
      aerolinea_id: '{{ if .Pasaje.AerolineaID }}{{ .Pasaje.AerolineaID }}{{ end }}',
      numero_vuelo: '{{ .Pasaje.NumeroVuelo }}',
      fecha_vuelo: '{{ .Pasaje.FechaVuelo.Format `2006-01-02T15:04` }}',
      fecha_emision: '{{ if .Pasaje.FechaEmision }}{{ .Pasaje.FechaEmision.Format `2006-01-02` }}{{ end }}',
      numero_boleto: '{{ .Pasaje.NumeroBoleto }}',
      numero_factura: '{{ .Pasaje.NumeroFactura }}',
      costo: '{{ .Pasaje.Costo }}',
      codigo_reserva: '{{ .Pasaje.CodigoReserva }}',
      glosa: '{{ .Pasaje.Glosa }}',
      fileName: '',
      loading: false,
      fares: {
          {{ range .Rutas }}
          '{{ .Tramo }}': {
              {{ range .Contratos }}
              '{{ .AerolineaID }}': {{ if .MontoReferencial }}{{ .MontoReferencial }}{{ else }}0{{ end }},
              {{ end }}
          },
          {{ end }}
      },
      get tarifaReferencial() {
          if (this.ruta && this.aerolinea_id && this.fares[this.ruta]) {
              return this.fares[this.ruta][this.aerolinea_id] || 0;
          }
          return 0;
      }
  }"
  x-show="open"
  @keydown.escape.window="open = false"
  class="fixed inset-0 z-50 overflow-y-auto"
  aria-labelledby="modal-title-edit"
  role="dialog"
  aria-modal="true"
  style="display: none">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div
      x-show="open"
      x-transition:enter="ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-neutral-500 bg-opacity-75 transition-opacity"
      aria-hidden="true"></div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <div
      x-show="open"
      x-transition:enter="ease-out duration-300"
      x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
      x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
      x-transition:leave="ease-in duration-200"
      x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
      x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
      class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="flex items-center justify-between mb-6 border-b pb-3">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
              <i class="ph ph-note-pencil text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-neutral-900" id="modal-title-edit">Editar Pasaje</h3>
          </div>
          <button @click="open = false" type="button" class="text-neutral-400 hover:text-neutral-600 transition-colors cursor-pointer p-1">
            <i class="ph ph-x text-2xl"></i>
          </button>
        </div>

        <form action="/pasajes/update" method="POST" enctype="multipart/form-data" @submit="loading = true">
          <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
          <input type="hidden" name="id" x-model="id" />

          <div class="grid grid-cols-6 gap-5">
            <div
              class="col-span-6"
              x-data="searchableSelect({
                    items: [
                        {{ range .Rutas }}
                        { value: '{{ .Tramo }}', label: '{{ .Tramo }}' },
                        {{ end }}
                    ],
                    initialValue: '{{ .Pasaje.Ruta }}',
                    initialLabel: '{{ .Pasaje.Ruta }}'
                })"
              x-init="$watch('value', v => { ruta = v })">
              <label class="block text-sm font-medium text-neutral-700">Ruta (Origen - Destino)</label>
              <div class="relative mt-1">
                <input type="hidden" name="ruta" :value="value" />

                <div class="relative">
                  <div
                    @click="open = true; $nextTick(function() { $refs.searchInput.focus() })"
                    x-show="!open"
                    class="w-full rounded-md border border-neutral-300 bg-white py-2 pl-3 pr-10 shadow-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm cursor-pointer flex items-center justify-between min-h-[38px]">
                    <span x-text="label || 'Seleccione una ruta'"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>

                  <input
                    x-ref="searchInput"
                    type="text"
                    x-model="search"
                    x-show="open"
                    @click.away="open = false"
                    @keydown.escape="open = false"
                    @keydown.enter.prevent="if (filteredItems.length > 0) select(filteredItems[0])"
                    placeholder="Buscar ruta..."
                    class="w-full rounded-md border border-secondary bg-white py-2 pl-3 pr-10 shadow-sm focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm" />

                  <ul
                    x-show="open"
                    class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"
                    x-cloak>
                    <template x-for="item in filteredItems" :key="item.value">
                      <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-900 hover:bg-primary hover:text-white" @click="select(item)">
                        <span class="block truncate" x-text="item.label"></span>
                      </li>
                    </template>
                    <li x-show="filteredItems.length === 0" class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-500">Sin resultados.</li>
                  </ul>
                </div>
              </div>
            </div>

            <div
              class="col-span-3"
              x-data="searchableSelect({
                   items: [
                     {{ range .Agencias }}
                     { value: '{{ .ID }}', label: '{{ .Nombre }}' },
                     {{ end }}
                   ],
                   initialValue: agencia_id,
                   initialLabel: '{{ if .Pasaje.Agencia }}{{ .Pasaje.Agencia.Nombre }}{{ end }}',
                   placeholder: '-- Seleccionar --'
                 })"
              x-init="$watch('value', function(v) { agencia_id = v })">
              <label class="block text-sm font-medium text-neutral-700">Agencia Emisora</label>
              <div class="relative mt-1">
                <input type="hidden" name="agencia_id" :value="value" required />
                <div class="relative">
                  <div
                    @click="open = true; $nextTick(function() { $refs.searchInput.focus() })"
                    x-show="!open"
                    class="w-full rounded-md border border-neutral-300 bg-white py-2 pl-3 pr-10 shadow-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm cursor-pointer flex items-center justify-between min-h-[38px]">
                    <span x-text="label || placeholder"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <input
                    x-ref="searchInput"
                    type="text"
                    x-model="search"
                    x-show="open"
                    @click.away="open = false"
                    @keydown.escape="open = false"
                    @keydown.enter.prevent="if (filteredItems.length > 0) select(filteredItems[0])"
                    placeholder="Buscar agencia..."
                    class="w-full rounded-md border border-secondary bg-white py-2 pl-3 pr-10 shadow-sm focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm" />
                  <ul
                    x-show="open"
                    class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"
                    x-cloak>
                    <template x-for="item in filteredItems" :key="item.value">
                      <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-900 hover:bg-primary hover:text-white" @click="select(item)">
                        <span class="block truncate" x-text="item.label"></span>
                      </li>
                    </template>
                    <li x-show="filteredItems.length === 0" class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-500">Sin resultados.</li>
                  </ul>
                </div>
              </div>
            </div>

            <div
              class="col-span-3"
              x-data="searchableSelect({
                   items: [
                     {{ range .Aerolineas }}
                     { value: '{{ .ID }}', label: '{{ .Nombre }}' },
                     {{ end }}
                   ],
                   initialValue: aerolinea_id,
                   initialLabel: '{{ if .Pasaje.Aerolinea }}{{ .Pasaje.Aerolinea.Nombre }}{{ end }}',
                   placeholder: '-- Seleccionar --'
                 })"
              x-init="$watch('value', function(v) { aerolinea_id = v })">
              <label class="block text-sm font-medium text-neutral-700">Aerolínea</label>
              <div class="relative mt-1">
                <input type="hidden" name="aerolinea_id" :value="value" required />
                <div class="relative">
                  <div
                    @click="open = true; $nextTick(function() { $refs.searchInput.focus() })"
                    x-show="!open"
                    class="w-full rounded-md border border-neutral-300 bg-white py-2 pl-3 pr-10 shadow-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm cursor-pointer flex items-center justify-between min-h-[38px]">
                    <span x-text="label || placeholder"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor">
                      <path
                        fill-rule="evenodd"
                        d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                    </svg>
                  </div>
                  <input
                    x-ref="searchInput"
                    type="text"
                    x-model="search"
                    x-show="open"
                    @click.away="open = false"
                    @keydown.escape="open = false"
                    @keydown.enter.prevent="if (filteredItems.length > 0) select(filteredItems[0])"
                    placeholder="Buscar aerolínea..."
                    class="w-full rounded-md border border-secondary bg-white py-2 pl-3 pr-10 shadow-sm focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm" />
                  <ul
                    x-show="open"
                    class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"
                    x-cloak>
                    <template x-for="item in filteredItems" :key="item.value">
                      <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-900 hover:bg-primary hover:text-white" @click="select(item)">
                        <span class="block truncate" x-text="item.label"></span>
                      </li>
                    </template>
                    <li x-show="filteredItems.length === 0" class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-500">Sin resultados.</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-span-3">
              <label class="block text-sm font-medium text-neutral-700">Fecha Emisión Boleto</label>
              <input
                type="text"
                name="fecha_emision"
                x-model="fecha_emision"
                x-flatpickr="{ enableTime: false, dateFormat: 'Y-m-d', altFormat: 'd/m/Y' }"
                required
                class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2 bg-white"
                placeholder="Seleccione fecha..." />
            </div>

            <div class="col-span-3">
              <label class="block text-sm font-medium text-neutral-700">Nº Boleto</label>
              <input
                type="text"
                name="numero_boleto"
                x-model="numero_boleto"
                required
                class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2" />
            </div>

            <div class="col-span-3">
              <label class="block text-sm font-medium text-neutral-700">Fecha y Hora Vuelo</label>
              <input
                type="text"
                name="fecha_vuelo"
                x-model="fecha_vuelo"
                x-flatpickr
                required
                class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2 bg-white"
                placeholder="Seleccione fecha y hora..." />
            </div>

            <div class="col-span-1">
              <label class="block text-sm font-medium text-neutral-700">Nº Vuelo</label>
              <input
                type="text"
                name="numero_vuelo"
                x-model="numero_vuelo"
                required
                class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2" />
            </div>

            <div class="col-span-2">
              <div class="flex items-center justify-between">
                <label class="block text-sm font-medium text-neutral-700">Costo (Bs)</label>
                <span
                  x-show="tarifaReferencial > 0"
                  class="text-[11px] font-bold text-primary-600 bg-primary-50 px-1.5 py-0.5 rounded border border-primary-100 flex items-center gap-1">
                  <i class="ph ph-tag"></i>
                  Ref:
                  <span x-text="tarifaReferencial.toLocaleString('es-BO', {minimumFractionDigits: 2})"></span>
                </span>
              </div>
              <input
                type="number"
                step="0.01"
                name="costo"
                x-model="costo"
                required
                class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2" />
            </div>

            <input type="hidden" name="codigo_reserva" x-model="codigo_reserva" />
            <input type="hidden" name="numero_factura" x-model="numero_factura" />

            <div class="col-span-6">
              <label class="block text-sm font-medium text-neutral-700">Observaciones / Glosa (Opcional)</label>
              <textarea
                name="glosa"
                x-model="glosa"
                rows="2"
                class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2"></textarea>
            </div>

            <div class="col-span-6 border-t border-neutral-100 pt-4">
              <label class="block text-sm font-medium text-neutral-700 mb-2">Reemplazar Billete (PDF) - Opcional</label>
              <div
                class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-neutral-300 border-dashed rounded-md bg-white hover:bg-neutral-50 transition-colors cursor-pointer relative group">
                <input
                  type="file"
                  name="archivo"
                  accept=".pdf"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                  @change="if($event.target.files.length > 0) { fileName = $event.target.files[0].name }" />

                <div class="space-y-1 text-center" x-show="!fileName">
                  <svg class="mx-auto h-12 w-12 text-neutral-400 group-hover:text-neutral-500 transition-colors" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path
                      d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                  <div class="flex text-sm text-neutral-600 justify-center">
                    <span class="font-bold text-secondary group-hover:underline">Cargar Nuevo Pasaje</span>
                  </div>
                  <p class="text-xs text-neutral-500">Solo archivos PDF</p>
                </div>

                <div class="space-y-1 text-center" x-show="fileName" x-cloak>
                  <div class="mx-auto h-12 w-12 bg-danger-100 rounded-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-danger-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                  </div>
                  <p class="text-sm font-bold text-neutral-900 truncate px-4" x-text="fileName"></p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-neutral-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse mt-4 -mx-6 -mb-4">
            <button
              type="submit"
              :disabled="loading"
              class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-800 focus:outline-none disabled:opacity-50 sm:ml-3 sm:w-auto sm:text-sm">
              <span x-show="!loading">Guardar Cambios</span>
              <span x-show="loading" class="flex items-center">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Guardando...
              </span>
            </button>
            <button
              type="button"
              @click="open = false"
              class="mt-3 w-full inline-flex justify-center rounded-md border border-neutral-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-neutral-700 hover:bg-neutral-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{{ end }}
