{{ define "solicitud/components/modal_crear_pasaje" }}
<div
  x-data="{
      open: true,
      ruta: '',
      aerolinea_id: '',
      agencia_id: '',
      fares: {
          {{ range .Rutas }}
          '{{ .Tramo }}': {
              {{ range .Contratos }}
              '{{ .AerolineaID }}': {{ .MontoReferencial }},
              {{ end }}
          },
          {{ end }}
      },
      get tarifaReferencial() {
          if (this.ruta && this.aerolinea_id && this.fares[this.ruta]) {
              return this.fares[this.ruta][this.aerolinea_id] || 0;
          }
          return 0;
      },
      loading: false,
      fileName: ''
  }"
  x-show="open"
 class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true" style="display: none">
  <div
    x-show="open"
    x-transition:enter="ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-neutral-500 bg-opacity-75 transition-opacity"></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div
        x-show="open"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-3xl">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex items-center justify-between mb-6 border-b pb-3">
            <div class="flex items-center gap-3">
               <div class="h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                 <i class="ph ph-airplane text-2xl"></i>
               </div>
               <div>
                 <h3 class="text-lg font-bold text-neutral-900" id="modal-title">Asignar Nuevo Pasaje</h3>
                 <div class="mt-1 flex flex-col gap-1 text-xs text-neutral-500">
                   <span class="flex items-center gap-1.5">
                     <i class="ph ph-calendar-blank shrink-0 text-neutral-400"></i>
                     {{ $selectedItem := "" }}{{ range .Solicitud.Items }}{{ if eq .ID $.SolicitudItemID }}{{ $selectedItem = . }}{{ end }}{{ end }}
                     <span>Viaje: <b class="text-neutral-700">{{ if $selectedItem }}{{ fechaHora $selectedItem.Fecha }}{{ else }}-{{ end }}</b></span>
                   </span>
                   {{ if .Solicitud.CupoDerechoItem }}
                   <span class="flex items-center gap-1.5">
                     <i class="ph ph-ticket shrink-0 text-neutral-400"></i>
                     <span>Cupo: <b class="text-neutral-700">{{ .Solicitud.CupoDerechoItem.Mes | nombreMes }} {{ .Solicitud.CupoDerechoItem.Gestion }}, {{ .Solicitud.CupoDerechoItem.Semana }}</b> <span class="text-neutral-400">({{ rangoSemanaCorto .Solicitud.CupoDerechoItem.FechaDesde .Solicitud.CupoDerechoItem.FechaHasta }})</span></span>
                   </span>
                   {{ end }}
                 </div>
               </div>
             </div>
             <div class="flex items-center gap-2">
                <button
                  type="submit"
                  form="createPasajeForm"
                  :disabled="loading || !fileName"
                  class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-sm font-bold text-white hover:bg-primary-800 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                  :title="!fileName ? 'Debe cargar el pasaje en PDF para continuar' : ''"
                  x-cloak>
                  <span x-show="!loading">Guardar</span>
                  <span x-show="loading" class="flex items-center"><i class="ph ph-spinner animate-spin mr-2"></i>Guardando...</span>
                </button>

               <button
                 type="button"
                 @click="open = false"
                 class="text-neutral-500 hover:text-neutral-700 text-sm font-medium px-3 py-2 bg-neutral-100 hover:bg-neutral-200 rounded-md transition-colors">
                 Cancelar
               </button>

               <button @click="open = false" type="button" class="text-neutral-400 hover:text-neutral-600 p-2 hover:bg-neutral-100 rounded-full transition-colors ml-1">
                 <i class="ph ph-x text-xl"></i>
               </button>
             </div>
          </div>

          <form id="createPasajeForm" action="/solicitudes/{{ .Solicitud.ID }}/pasajes" method="POST" enctype="multipart/form-data" @submit="loading = true">
            <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
            <div class="grid grid-cols-6 gap-6">
              <div class="col-span-6 flex items-stretch gap-3">
                <!-- Pasajero -->
                <div class="flex-1 bg-primary-50 p-2.5 rounded-lg border border-primary-100 flex flex-col justify-center min-w-0">
                  <span class="text-[10px] font-bold text-primary-600 uppercase tracking-widest leading-none mb-1">Pasajero</span>
                  <span class="text-sm font-black text-neutral-800 truncate">{{ .Solicitud.Usuario.GetNombreCompleto }}</span>
                </div>

                <!-- Segmento -->
                <div class="flex-[1.5] bg-neutral-50 p-2.5 rounded-lg border border-neutral-200 shadow-sm flex items-center min-w-0">
                  {{ $selectedItem := "" }}
                  {{ range .Solicitud.Items }}
                    {{ if eq .ID $.SolicitudItemID }}
                      {{ $selectedItem = . }}
                    {{ end }}
                  {{ end }}
                  <input type="hidden" name="solicitud_item_id" value="{{ $.SolicitudItemID }}" />

                  {{ if $selectedItem }}
                  <div class="flex items-center gap-3 w-full">
                    <div class="h-8 w-8 shrink-0 rounded flex items-center justify-center {{ if eq $selectedItem.Tipo "IDA" }} bg-white text-primary-600 shadow-sm {{ else }} bg-white text-secondary-600 shadow-sm {{ end }}">
                      <i class="ph {{ if eq $selectedItem.Tipo "IDA" }}ph-airplane-takeoff{{ else }}ph-airplane-landing{{ end }} text-lg"></i>
                    </div>
                    <div class="min-w-0">
                      <span class="text-[9px] font-black uppercase text-neutral-400 tracking-tighter block leading-none mb-0.5">{{ $selectedItem.Tipo }}</span>
                      <h4 class="text-xs font-bold text-neutral-900 leading-tight truncate">
                        {{ if $selectedItem.Origen }}{{ $selectedItem.Origen.Ciudad }} ({{ $selectedItem.Origen.IATA }}){{ else }}{{ $selectedItem.OrigenIATA }}{{ end }}
                        <i class="ph ph-arrow-right mx-0.5 text-neutral-300"></i>
                        {{ if $selectedItem.Destino }}{{ $selectedItem.Destino.Ciudad }} ({{ $selectedItem.Destino.IATA }}){{ else }}{{ $selectedItem.DestinoIATA }}{{ end }}
                      </h4>
                    </div>
                  </div>
                  {{ else }}
                  <p class="text-[10px] text-danger-600 font-bold italic">Tramo no identificado</p>
                  {{ end }}
                </div>
              </div>

              <div
                class="col-span-6"
                x-data="searchableSelect({
                  items: [
                      {{ range .Rutas }}
                      { value: '{{ .Tramo }}', label: '{{ .Tramo }}' },
                      {{ end }}
                  ],
                  initialValue: '',
                  initialLabel: ''
                })"
              x-init="$watch('value', v => { ruta = v })">
                <label class="block text-sm font-medium text-neutral-700">Ruta (Incluyendo Escalas)</label>
                <div class="relative mt-1">
                  <input type="hidden" name="ruta" :value="value" required />

                  <div class="relative">
                    <div
                      @click="open = true; $nextTick(function() { $refs.searchInput.focus() })"
                      x-show="!open"
                      class="w-full rounded-md border border-neutral-300 bg-white py-2 pl-3 pr-10 shadow-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm cursor-pointer flex items-center justify-between min-h-[38px]">
                      <span x-text="label || 'Seleccione una ruta'"></span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor">
                        <path
                          fill-rule="evenodd"
                          d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                          clip-rule="evenodd" />
                      </svg>
                    </div>

                    <input
                      x-ref="searchInput"
                      type="text"
                      x-model="search"
                      x-show="open"
                      @click.away="open = false"
                      @keydown.escape="open = false"
                      @keydown.enter.prevent="if (filteredItems.length > 0) select(filteredItems[0])"
                      placeholder="Buscar ruta..."
                      class="w-full rounded-md border border-secondary bg-white py-2 pl-3 pr-10 shadow-sm focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm" />

                    <ul
                      x-show="open"
                      class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"
                      x-cloak>
                      <template x-for="item in filteredItems" :key="item.value">
                        <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-900 hover:bg-primary hover:text-white" @click="select(item)">
                          <span class="block truncate" x-text="item.label"></span>
                        </li>
                      </template>
                      <li x-show="filteredItems.length === 0" class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-500">Sin resultados.</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div
                class="col-span-3"
                x-data="searchableSelect({
                     items: [
                       {{ range .Agencias }}
                       { value: '{{ .ID }}', label: '{{ .Nombre }}' },
                       {{ end }}
                     ],
                     placeholder: '-- Seleccionar --'
                   })"
                x-init="$watch('value', v => { agencia_id = v })">
                <label class="block text-sm font-medium text-neutral-700">Agencia Emisora</label>
                <div class="relative mt-1">
                  <input type="hidden" name="agencia_id" :value="value" required />

                  <div class="relative">
                    <div
                      @click="open = true; $nextTick(function() { $refs.searchInput.focus() })"
                      x-show="!open"
                      class="w-full rounded-md border border-neutral-300 bg-white py-2 pl-3 pr-10 shadow-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm cursor-pointer flex items-center justify-between min-h-[38px]">
                      <span x-text="label || placeholder"></span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor">
                        <path
                          fill-rule="evenodd"
                          d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                          clip-rule="evenodd" />
                      </svg>
                    </div>

                    <input
                      x-ref="searchInput"
                      type="text"
                      x-model="search"
                      x-show="open"
                      @click.away="open = false"
                      @keydown.escape="open = false"
                      @keydown.enter.prevent="if (filteredItems.length > 0) select(filteredItems[0])"
                      placeholder="Buscar agencia..."
                      class="w-full rounded-md border border-secondary bg-white py-2 pl-3 pr-10 shadow-sm focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm" />

                    <ul
                      x-show="open"
                      class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"
                      x-cloak>
                      <template x-for="item in filteredItems" :key="item.value">
                        <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-900 hover:bg-primary hover:text-white" @click="select(item)">
                          <span class="block truncate" x-text="item.label"></span>
                        </li>
                      </template>
                      <li x-show="filteredItems.length === 0" class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-500">Sin resultados.</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div
                class="col-span-3"
                x-data="searchableSelect({
                     items: [
                       {{ range .Aerolineas }}
                       { value: '{{ .ID }}', label: '{{ .Nombre }}' },
                       {{ end }}
                     ],
                     placeholder: '-- Seleccionar --'
                   })"
                x-init="$watch('value', v => { aerolinea_id = v })">
                <label class="block text-sm font-medium text-neutral-700">Aerolínea</label>
                <div class="relative mt-1">
                  <input type="hidden" name="aerolinea_id" :value="value" required />

                  <div class="relative">
                    <div
                      @click="open = true; $nextTick(function() { $refs.searchInput.focus() })"
                      x-show="!open"
                      class="w-full rounded-md border border-neutral-300 bg-white py-2 pl-3 pr-10 shadow-sm focus:border-secondary focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm cursor-pointer flex items-center justify-between min-h-[38px]">
                      <span x-text="label || placeholder"></span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor">
                        <path
                          fill-rule="evenodd"
                          d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                          clip-rule="evenodd" />
                      </svg>
                    </div>

                    <input
                      x-ref="searchInput"
                      type="text"
                      x-model="search"
                      x-show="open"
                      @click.away="open = false"
                      @keydown.escape="open = false"
                      @keydown.enter.prevent="if (filteredItems.length > 0) select(filteredItems[0])"
                      placeholder="Buscar aerolínea..."
                      class="w-full rounded-md border border-secondary bg-white py-2 pl-3 pr-10 shadow-sm focus:outline-none focus:ring-1 focus:ring-secondary sm:text-sm" />

                    <ul
                      x-show="open"
                      class="absolute z-50 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm"
                      x-cloak>
                      <template x-for="item in filteredItems" :key="item.value">
                        <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-900 hover:bg-primary hover:text-white" @click="select(item)">
                          <span class="block truncate" x-text="item.label"></span>
                        </li>
                      </template>
                      <li x-show="filteredItems.length === 0" class="relative cursor-default select-none py-2 pl-3 pr-9 text-neutral-500">Sin resultados.</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="col-span-3">
                <label class="block text-sm font-medium text-neutral-700">Fecha Emisión Boleto</label>
                <input
                  type="date"
                  name="fecha_emision"
                  required
                  class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2" />
              </div>

              <div class="col-span-3">
                <label class="block text-sm font-medium text-neutral-700">Nº Boleto</label>
                <input
                  type="text"
                  name="numero_boleto"
                  required
                  class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2"
                  placeholder="Ej: 93021..." />
              </div>

              <div class="col-span-3">
                <label class="block text-sm font-medium text-neutral-700">Fecha y Hora Vuelo</label>
                <input
                  type="datetime-local"
                  name="fecha_vuelo"
                  required
                  class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2" />
              </div>

              <div class="col-span-1">
                <label class="block text-sm font-medium text-neutral-700">Nº Vuelo</label>
                <input
                  type="text"
                  name="numero_vuelo"
                  required
                  class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2"
                  placeholder="Ej: OB-123" />
              </div>

               <div class="col-span-2">
                 <div class="flex items-center justify-between">
                   <label class="block text-sm font-medium text-neutral-700">Costo (Bs)</label>
                   <span x-show="tarifaReferencial > 0" class="text-[11px] font-bold text-primary-600 bg-primary-50 px-1.5 py-0.5 rounded border border-primary-100 flex items-center gap-1">
                     <i class="ph ph-tag"></i>
                     Ref: <span x-text="tarifaReferencial.toLocaleString('es-BO', {minimumFractionDigits: 2})"></span>
                   </span>
                 </div>
                 <input
                   type="number"
                   step="0.01"
                   name="costo"
                   required
                   class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2" />
               </div>

              <input type="hidden" name="codigo_reserva" value="" />
              <input type="hidden" name="numero_factura" value="" />

              <div class="col-span-6">
                <label class="block text-sm font-medium text-neutral-700">Observaciones / Glosa (Opcional)</label>
                <textarea
                  name="glosa"
                  rows="2"
                  class="mt-1 focus:ring-secondary focus:border-secondary block w-full shadow-sm sm:text-sm border-neutral-300 rounded-md border p-2"
                  placeholder="Detalles adicionales..."></textarea>
              </div>

              <div class="col-span-6 border-t border-neutral-100 pt-4">
                <label class="block text-sm font-medium text-neutral-700 mb-2">Billete Electrónico (PDF)</label>
                <div
                  class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-neutral-300 border-dashed rounded-md bg-white hover:bg-neutral-50 transition-colors cursor-pointer relative group">
                  <input
                    type="file"
                    name="archivo"
                    accept=".pdf"
                    required
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                    @change="if($event.target.files.length > 0) { fileName = $event.target.files[0].name }" />

                  <div class="space-y-1 text-center" x-show="!fileName">
                    <svg class="mx-auto h-12 w-12 text-neutral-400 group-hover:text-neutral-500 transition-colors" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                      <path
                        d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round" />
                    </svg>
                    <div class="flex text-sm text-neutral-600 justify-center">
                      <span class="font-bold text-secondary group-hover:underline">Cargar Pasaje</span>
                      <p class="pl-1">o arrastrar aquí</p>
                    </div>
                    <p class="text-xs text-neutral-500">Solo archivos PDF</p>
                  </div>

                  <div class="space-y-1 text-center" x-show="fileName" x-cloak>
                    <div class="mx-auto h-12 w-12 bg-danger-100 rounded-full flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-danger-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                    </div>
                    <p class="text-sm font-bold text-neutral-900 truncate px-4" x-text="fileName"></p>
                    <p class="text-xs text-success-600 font-medium">✓ Listo para subir</p>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{{ end }}
