{{ define "solicitud/oficial/modal_create" }}
<div
  x-data="oficialFormHandler()"
  x-init="init()"
  @oficial-sync-chain.window="syncChain()"
  x-show="open"
  class="fixed inset-0 z-50 overflow-y-auto"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
  style="display: none">
  <!-- Backdrop -->
  <div x-show="open" class="fixed inset-0 bg-neutral-500 bg-opacity-75 transition-opacity"></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div
        x-show="open"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-5xl">
        <form x-ref="form" @submit.prevent="submitForm" action="/solicitudes/oficial" method="POST" autocomplete="off">
          <input type="hidden" name="tipo_solicitud_codigo" value="COMISION" />
          <input type="hidden" name="tramos_json" id="tramos_json_input" value="" />
          {{ if .IsAdmin }}
          <input type="hidden" name="target_user_id" value="{{ .TargetUser.ID }}" />
          {{ end }}

          <!-- Header -->
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 border-b border-neutral-200 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
            <div class="flex items-center">
              <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                <i class="ph ph-airplane-tilt text-2xl"></i>
              </div>
              <div class="ml-4 text-left">
                <h3 class="text-lg font-bold text-neutral-900">Nueva Solicitud Oficial</h3>
                <p class="text-sm text-neutral-500">Itinerario para {{ .TargetUser.GetNombreCompleto }}</p>
              </div>
            </div>

            <div class="flex gap-2">
              <button
                type="submit"
                :disabled="loading"
                class="bg-primary text-white px-4 py-2 rounded-md font-bold text-sm shadow-sm hover:bg-primary-700 disabled:opacity-50 transition-colors">
                <span x-show="!loading">Guardar Solicitud</span>
                <span x-show="loading">Procesando...</span>
              </button>
              <button @click="open = false" type="button" class="bg-white border border-neutral-300 text-neutral-700 px-4 py-2 rounded-md font-bold text-sm hover:bg-neutral-50">
                Cancelar
              </button>
            </div>
          </div>

          <div class="p-6 space-y-8 max-h-[75vh] overflow-y-auto">
            <!-- Ambito -->
            <div class="w-full md:w-1/3">
              <label class="block text-xs font-black text-neutral-500 uppercase tracking-widest mb-1">Ámbito del Viaje</label>
              <select name="ambito_viaje_codigo" x-model="ambito" required class="w-full rounded-md border-neutral-300 text-sm focus:ring-primary focus:border-primary">
                <option value="">Seleccione...</option>
                {{ range .Ambitos }}
                <option value="{{ .Codigo }}">{{ .Nombre }}</option>
                {{ end }}
              </select>
            </div>

            <!-- SECCIÓN: RUTA DE IDA -->
            <div class="space-y-4">
              <div class="flex items-center justify-between border-b border-neutral-100 pb-2">
                <div class="flex items-center gap-2 text-primary-600">
                  <i class="ph ph-airplane-takeoff text-xl"></i>
                  <h4 class="text-sm font-black uppercase tracking-widest">Ruta de Ida</h4>
                </div>
                <button
                  type="button"
                  @click="addTramo('IDA')"
                  class="text-primary-600 text-xs font-bold flex items-center gap-1 hover:text-primary-800 bg-primary-50 px-3 py-1.5 rounded-full transition-colors">
                  <i class="ph ph-plus-circle"></i>
                  Agregar Escala de Ida
                </button>
              </div>

              <div class="space-y-4">
                <template x-for="(tramo, index) in tramos" :key="index">
                  <div x-show="tramo.tipo === 'IDA'" class="bg-neutral-50 border border-neutral-200 rounded-xl p-4 relative group">
                    <input type="hidden" :name="'tramos['+index+'].tipo'" value="IDA" />

                    <!-- Botón eliminar (solo si no es el primer tramo de ida) -->
                    <button
                      type="button"
                      x-show="canRemoveTramo(index)"
                      @click="removeTramo(index)"
                      class="absolute -top-2 -right-2 h-6 w-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition-all z-10">
                      <i class="ph ph-x text-xs"></i>
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                      <div class="md:col-span-4 space-y-1">
                        <label class="block text-[10px] font-black text-neutral-500 uppercase tracking-widest ml-1">Origen</label>
                        <input type="hidden" :name="'tramos['+index+'].origen'" x-model="tramo.origen" required />
                        <div x-show="!canEditOrigin(index)" class="w-full rounded-md border border-neutral-200 bg-neutral-100 py-2 pl-3 pr-10 shadow-sm sm:text-sm flex items-center min-h-[38px]">
                          <span x-text="tramo.origenLabel || '-'" class="text-neutral-700"></span>
                          <i class="ph ph-lock-simple text-neutral-400 ml-auto"></i>
                        </div>
                        <div
                          x-show="canEditOrigin(index)"
                          x-data="searchableSelect({
                            items: allDestinos,
                            initialValue: tramo.origen,
                            initialLabel: tramo.origenLabel,
                            placeholder: 'Buscar origen...'
                          })"
                          x-init="value = tramo.origen; label = tramo.origenLabel || placeholder; $watch('value', function(v) { tramo.origen = v; var it = allDestinos.find(function(d) { return d.value === v; }); if (it) tramo.origenLabel = it.value + ' - ' + it.label; setTimeout(function() { window.dispatchEvent(new CustomEvent('oficial-sync-chain')); }, 0); })"
                          class="relative">
                          <button
                            type="button"
                            @click="open = !open; if(open) $nextTick(function() { $refs.searchInput.focus() })"
                            class="relative w-full bg-white border border-neutral-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-pointer focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm min-h-[38px] flex items-center justify-between">
                            <span class="block truncate" :class="label ? 'text-neutral-900' : 'text-neutral-400'" x-text="label || placeholder"></span>
                            <i class="ph ph-magnifying-glass text-neutral-400"></i>
                          </button>
                          <div x-show="open" @click.away="open = false" class="absolute z-50 mt-1 w-full bg-white shadow-xl max-h-48 rounded-md border border-neutral-200 overflow-hidden" style="display: none">
                            <div class="sticky top-0 bg-white p-2 border-b border-neutral-100">
                              <input x-ref="searchInput" x-model="search" type="text" autocomplete="off" class="w-full border-neutral-300 rounded text-sm focus:ring-primary focus:border-primary" placeholder="Buscar ciudad..." />
                            </div>
                            <div class="max-h-36 overflow-y-auto">
                              <template x-for="item in filteredItems" :key="item.value">
                                <div @click="select(item)" class="px-3 py-2 hover:bg-primary hover:text-white cursor-pointer text-xs font-bold border-b border-neutral-50">
                                  <span x-text="item.value + ' - ' + item.label"></span>
                                </div>
                              </template>
                              <div x-show="filteredItems.length === 0" class="px-3 py-2 text-neutral-500 text-xs italic">Sin resultados</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="hidden md:flex md:col-span-1 justify-center pb-3"><i class="ph ph-arrow-right text-neutral-300 text-xl font-bold"></i></div>

                      <div class="md:col-span-4 space-y-1">
                        <label class="block text-[10px] font-black text-neutral-500 uppercase tracking-widest ml-1">Destino</label>
                        <div
                          x-data="searchableSelect({
                            items: allDestinos,
                            initialValue: tramo.destino,
                            initialLabel: tramo.destinoLabel,
                            placeholder: 'Buscar destino...'
                          })"
                          x-init="value = tramo.destino; label = tramo.destinoLabel || placeholder; $watch('value', function(v) { tramo.destino = v; var it = allDestinos.find(function(d) { return d.value === v; }); if (it) tramo.destinoLabel = it.value + ' - ' + it.label; setTimeout(function() { window.dispatchEvent(new CustomEvent('oficial-sync-chain')); }, 0); })"
                          class="relative">
                          <input type="hidden" :name="'tramos['+index+'].destino'" x-model="tramo.destino" required />
                          <button
                            type="button"
                            @click="open = !open; if(open) $nextTick(function() { $refs.searchInput.focus() })"
                            class="relative w-full bg-white border border-neutral-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-pointer focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm min-h-[38px] flex items-center justify-between">
                            <span class="block truncate" :class="label ? 'text-neutral-900' : 'text-neutral-400'" x-text="label || placeholder"></span>
                            <i class="ph ph-magnifying-glass text-neutral-400"></i>
                          </button>
                          <div x-show="open" @click.away="open = false" class="absolute z-50 mt-1 w-full bg-white shadow-xl max-h-48 rounded-md border border-neutral-200 overflow-hidden" style="display: none">
                            <div class="sticky top-0 bg-white p-2 border-b border-neutral-100">
                              <input x-ref="searchInput" x-model="search" type="text" autocomplete="off" class="w-full border-neutral-300 rounded text-sm focus:ring-primary focus:border-primary" placeholder="Buscar ciudad..." />
                            </div>
                            <div class="max-h-36 overflow-y-auto">
                              <template x-for="item in filteredItems" :key="item.value">
                                <div @click="select(item)" class="px-3 py-2 hover:bg-primary hover:text-white cursor-pointer text-xs font-bold border-b border-neutral-50">
                                  <span x-text="item.value + ' - ' + item.label"></span>
                                </div>
                              </template>
                              <div x-show="filteredItems.length === 0" class="px-3 py-2 text-neutral-500 text-xs italic">Sin resultados</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="md:col-span-3 space-y-1">
                        <label class="block text-[10px] font-black text-neutral-500 uppercase tracking-widest ml-1">Fecha Salida</label>
                        <input
                          type="datetime-local"
                          :name="'tramos['+index+'].fecha_salida'"
                          x-model="tramo.fechaSalida"
                          required
                          class="w-full rounded-md border-neutral-300 shadow-sm text-sm focus:ring-primary focus:border-primary" />
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- SECCIÓN: RUTA DE VUELTA -->
            <div class="space-y-4 pt-4">
              <div class="flex items-center justify-between border-b border-neutral-100 pb-2">
                <div class="flex items-center gap-2 text-secondary-600">
                  <i class="ph ph-airplane-landing text-xl"></i>
                  <h4 class="text-sm font-black uppercase tracking-widest">Ruta de Vuelta (Opcional)</h4>
                </div>
                <button
                  type="button"
                  @click="addTramo('VUELTA')"
                  class="text-secondary-600 text-xs font-bold flex items-center gap-1 hover:text-secondary-800 bg-secondary-50 px-3 py-1.5 rounded-full transition-colors">
                  <i class="ph ph-plus-circle"></i>
                  Agregar Escala de Vuelta
                </button>
              </div>

              <div class="space-y-4">
                <template x-for="(tramo, index) in tramos" :key="index">
                  <div x-show="tramo.tipo === 'VUELTA'" class="bg-neutral-50 border border-neutral-200 rounded-xl p-4 relative group border-l-4 border-l-secondary-400">
                    <input type="hidden" :name="'tramos['+index+'].tipo'" value="VUELTA" />

                    <button
                      type="button"
                      @click="removeTramo(index)"
                      class="absolute -top-2 -right-2 h-6 w-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition-all z-10">
                      <i class="ph ph-x text-xs"></i>
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                      <div class="md:col-span-4 space-y-1">
                        <label class="block text-[10px] font-black text-neutral-500 uppercase tracking-widest ml-1">Origen</label>
                        <input type="hidden" :name="'tramos['+index+'].origen'" x-model="tramo.origen" required />
                        <div x-show="!canEditOrigin(index)" class="w-full rounded-md border border-neutral-200 bg-neutral-100 py-2 pl-3 pr-10 shadow-sm sm:text-sm flex items-center min-h-[38px]">
                          <span x-text="tramo.origenLabel || '-'" class="text-neutral-700"></span>
                          <i class="ph ph-lock-simple text-neutral-400 ml-auto"></i>
                        </div>
                        <div
                          x-show="canEditOrigin(index)"
                          x-data="searchableSelect({
                            items: allDestinos,
                            initialValue: tramo.origen,
                            initialLabel: tramo.origenLabel,
                            placeholder: 'Buscar origen...'
                          })"
                          x-init="value = tramo.origen; label = tramo.origenLabel || placeholder; $watch('value', function(v) { tramo.origen = v; var it = allDestinos.find(function(d) { return d.value === v; }); if (it) tramo.origenLabel = it.value + ' - ' + it.label; setTimeout(function() { window.dispatchEvent(new CustomEvent('oficial-sync-chain')); }, 0); })"
                          class="relative">
                          <button
                            type="button"
                            @click="open = !open; if(open) $nextTick(function() { $refs.searchInput.focus() })"
                            class="relative w-full bg-white border border-neutral-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-pointer focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm min-h-[38px] flex items-center justify-between">
                            <span class="block truncate" :class="label ? 'text-neutral-900' : 'text-neutral-400'" x-text="label || placeholder"></span>
                            <i class="ph ph-magnifying-glass text-neutral-400"></i>
                          </button>
                          <div x-show="open" @click.away="open = false" class="absolute z-50 mt-1 w-full bg-white shadow-xl max-h-48 rounded-md border border-neutral-200 overflow-hidden" style="display: none">
                            <div class="sticky top-0 bg-white p-2 border-b border-neutral-100">
                              <input x-ref="searchInput" x-model="search" type="text" autocomplete="off" class="w-full border-neutral-300 rounded text-sm focus:ring-primary focus:border-primary" placeholder="Buscar ciudad..." />
                            </div>
                            <div class="max-h-36 overflow-y-auto">
                              <template x-for="item in filteredItems" :key="item.value">
                                <div @click="select(item)" class="px-3 py-2 hover:bg-primary hover:text-white cursor-pointer text-xs font-bold border-b border-neutral-50">
                                  <span x-text="item.value + ' - ' + item.label"></span>
                                </div>
                              </template>
                              <div x-show="filteredItems.length === 0" class="px-3 py-2 text-neutral-500 text-xs italic">Sin resultados</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="hidden md:flex md:col-span-1 justify-center pb-3"><i class="ph ph-arrow-right text-neutral-300 text-xl font-bold"></i></div>

                      <div class="md:col-span-4 space-y-1">
                        <label class="block text-[10px] font-black text-neutral-500 uppercase tracking-widest ml-1">Destino</label>
                        <div
                          x-data="searchableSelect({
                            items: allDestinos,
                            initialValue: tramo.destino,
                            initialLabel: tramo.destinoLabel,
                            placeholder: 'Buscar destino...'
                          })"
                          x-init="value = tramo.destino; label = tramo.destinoLabel || placeholder; $watch('value', function(v) { tramo.destino = v; var it = allDestinos.find(function(d) { return d.value === v; }); if (it) tramo.destinoLabel = it.value + ' - ' + it.label; setTimeout(function() { window.dispatchEvent(new CustomEvent('oficial-sync-chain')); }, 0); })"
                          class="relative">
                          <input type="hidden" :name="'tramos['+index+'].destino'" x-model="tramo.destino" required />
                          <button
                            type="button"
                            @click="open = !open; if(open) $nextTick(function() { $refs.searchInput.focus() })"
                            class="relative w-full bg-white border border-neutral-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-pointer focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm min-h-[38px] flex items-center justify-between">
                            <span class="block truncate" :class="label ? 'text-neutral-900' : 'text-neutral-400'" x-text="label || placeholder"></span>
                            <i class="ph ph-magnifying-glass text-neutral-400"></i>
                          </button>
                          <div x-show="open" @click.away="open = false" class="absolute z-50 mt-1 w-full bg-white shadow-xl max-h-48 rounded-md border border-neutral-200 overflow-hidden" style="display: none">
                            <div class="sticky top-0 bg-white p-2 border-b border-neutral-100">
                              <input x-ref="searchInput" x-model="search" type="text" autocomplete="off" class="w-full border-neutral-300 rounded text-sm focus:ring-primary focus:border-primary" placeholder="Buscar ciudad..." />
                            </div>
                            <div class="max-h-36 overflow-y-auto">
                              <template x-for="item in filteredItems" :key="item.value">
                                <div @click="select(item)" class="px-3 py-2 hover:bg-primary hover:text-white cursor-pointer text-xs font-bold border-b border-neutral-50">
                                  <span x-text="item.value + ' - ' + item.label"></span>
                                </div>
                              </template>
                              <div x-show="filteredItems.length === 0" class="px-3 py-2 text-neutral-500 text-xs italic">Sin resultados</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="md:col-span-3 space-y-1">
                        <label class="block text-[10px] font-black text-neutral-500 uppercase tracking-widest ml-1">Fecha Salida</label>
                        <input
                          type="datetime-local"
                          :name="'tramos['+index+'].fecha_salida'"
                          x-model="tramo.fechaSalida"
                          class="w-full rounded-md border-neutral-300 shadow-sm text-sm focus:ring-primary focus:border-primary" />
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- Motivo Final -->
            <div class="pt-6 border-t border-neutral-100 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label class="block text-xs font-black text-neutral-500 uppercase mb-1">Motivo de la Comisión</label>
                <textarea
                  name="motivo"
                  x-model="motivo"
                  rows="2"
                  required
                  class="w-full rounded-md border-neutral-300 text-sm"
                  placeholder="Describa el propósito del viaje oficial completo..."></textarea>
              </div>
              <div>
                <label class="block text-xs font-black text-neutral-500 uppercase mb-1">Autorización / Referencia</label>
                <input type="text" name="autorizacion" x-model="autorizacion" class="w-full rounded-md border-neutral-300 text-sm" placeholder="Ej: Resolución 001/2024" />
              </div>
              <div>
                <label class="block text-xs font-black text-neutral-500 uppercase mb-1">Aerolínea Sugerida</label>
                <select name="aerolinea" x-model="aerolinea" class="w-full rounded-md border-neutral-300 text-sm">
                  <option value="">Cualquiera</option>
                  {{ range .Aerolineas }}
                  <option value="{{ .Nombre }}">{{ .Nombre }}</option>
                  {{ end }}
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function oficialFormHandler() {
      return {
        open: true,
        loading: false,
        ambito: '',
        motivo: '',
        autorizacion: '',
        aerolinea: '',
        allDestinos: [
          {{ range .Destinos }}
          { value: "{{ .IATA }}", label: "{{ .GetLabel }}", ambito: "{{ .AmbitoCodigo }}" },
          {{ end }}
        ],
        tramos: [],

        init() {
          const defaultOrigin = '{{ .TargetUser.GetOrigenIATA }}';
          const defaultLabel = '{{ range .Destinos }}{{ if eq .IATA $.TargetUser.GetOrigenIATA }}{{ .GetLabel }}{{ end }}{{ end }}';

          this.tramos = [
            {
              tipo: 'IDA',
              origen: defaultOrigin,
              origenLabel: defaultOrigin + ' - ' + defaultLabel,
              destino: '',
              destinoLabel: '',
              fechaSalida: '{{ .DefaultDate }}'
            }
          ];
        },

        addTramo(tipo) {
          // Buscamos el último destino global para conectar
          let lastOrigin = '';
          let lastLabel = '';

          if (this.tramos.length > 0) {
            const last = this.tramos[this.tramos.length - 1];
            lastOrigin = last.destino;
            lastLabel = last.destinoLabel;
          }

          this.tramos.push({
            tipo: tipo,
            origen: lastOrigin,
            origenLabel: lastLabel,
            destino: '',
            destinoLabel: '',
            fechaSalida: ''
          });
        },

        canRemoveTramo(index) {
          // No permitir borrar el primer tramo de ida
          const tramo = this.tramos[index];
          if (tramo.tipo === 'IDA') {
             return this.tramos.filter(t => t.tipo === 'IDA').length > 1;
          }
          return true;
        },

        removeTramo(index) {
          this.tramos.splice(index, 1);
          this.syncChain();
        },

        canEditOrigin(index) {
          // Solo el primer tramo de la IDA es editable.
          // Todos los demás conectan con el destino anterior.
          return index === 0;
        },

        syncChain() {
          // Asegura que cada tramo (excepto el primero) empiece donde terminó el anterior
          for (let i = 1; i < this.tramos.length; i++) {
            this.tramos[i].origen = this.tramos[i-1].destino;
            this.tramos[i].origenLabel = this.tramos[i-1].destinoLabel;
          }
        },

        submitForm() {
          var el = document.getElementById('tramos_json_input');
          if (el) {
            el.value = JSON.stringify(this.tramos.map(function(t) {
              return { origen: t.origen || '', destino: t.destino || '', fecha_salida: t.fechaSalida || '', tipo: t.tipo || 'IDA' };
            }));
          }
          this.loading = true;
          this.$refs.form.submit();
        }
      }
    }
  </script>
</div>
{{ end }}
