{{ define "solicitud/edit.html" }} {{ template "layout_start" . }}

<div class="max-w-4xl mx-auto">
  <div class="md:flex md:items-center md:justify-between mb-6">
    <div class="flex-1 min-w-0">
      <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">Editar Solicitud #{{ .Solicitud.Codigo }}</h2>
      <p class="text-sm text-gray-500 mt-1">Modifique los datos de su solicitud (FV-01)</p>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
      <a
        href="{{ if .Solicitud.VoucherID }}/cupos/derecho/{{ .Solicitud.UsuarioID }}{{ else }}/solicitudes/{{ .Solicitud.ID }}{{ end }}"
        class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
        {{ if .Solicitud.VoucherID }}Volver a Lista{{ else }}Cancelar{{ end }}
      </a>
    </div>
  </div>

  <form action="/solicitudes/{{ .Solicitud.ID }}/actualizar" method="POST" class="bg-white shadow rounded-lg overflow-hidden border border-gray-200">
    <div class="p-6 space-y-6">
      <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
        <div class="sm:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Concepto</label>
          <input
            type="text"
            readonly
            value="{{ .Solicitud.TipoSolicitud.ConceptoViaje.Nombre }}"
            class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm sm:text-sm p-2 text-gray-500 cursor-not-allowed" />
        </div>

        <!-- Tipo Solicitud -->
        <div class="sm:col-span-2">
          <label for="tipo_solicitud_id" class="block text-sm font-medium text-gray-700">Tipo de Solicitud</label>
          <div class="mt-1">
            <select
              id="tipo_solicitud_id"
              name="tipo_solicitud_id"
              required
              class="shadow-sm focus:ring-senado-secondary focus:border-senado-secondary block w-full sm:text-sm border-gray-300 rounded-md p-2 border">
              {{ range .TiposSolicitud }}
              <option value="{{ .ID }}" {{ if eq .ID $.Solicitud.TipoSolicitudID }}selected{{ end }}>{{ .Nombre }}</option>
              {{ end }}
            </select>
          </div>
        </div>

        <!-- Ámbito -->
        <div class="sm:col-span-2">
          <label for="ambito_viaje_id" class="block text-sm font-medium text-gray-700">Ámbito</label>
          <div class="mt-1">
            <select
              id="ambito_viaje_id"
              name="ambito_viaje_id"
              required
              class="shadow-sm focus:ring-senado-secondary focus:border-senado-secondary block w-full sm:text-sm border-gray-300 rounded-md p-2 border">
              {{ range .AmbitosViaje }}
              <option value="{{ .ID }}" {{ if eq .ID $.Solicitud.AmbitoViajeID }}selected{{ end }}>{{ .Nombre }}</option>
              {{ end }}
            </select>
          </div>
        </div>

        <!-- Origen y Destino -->
        <!-- Origen y Destino con Lógica Estricta Restored -->
        <div
          class="sm:col-span-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6"
          x-data="{ 
                tipo: '{{ if .Solicitud.TipoItinerario }}{{ if .Solicitud.TipoItinerario.EsIdaVuelta }}IDA_VUELTA{{ else }}SOLO_IDA{{ end }}{{ else }}IDA_VUELTA{{ end }}',
                origen: '{{ .Solicitud.OrigenCode }}',
                userOrigenCode: '{{ .User.GetOrigenIATA }}',
                userOrigenName: '{{ if .User.Origen }}{{ .User.Origen.Nombre }}{{ else }}Mi Origen{{ end }}',
                lpbCode: 'LPB',
                lpbName: 'La Paz - El Alto',
                isLocked: true
             }"
          x-effect="
                if (tipo === 'IDA_VUELTA') {
                  isLocked = true;
                  if (origen !== 'LPB' && origen !== userOrigenCode && userOrigenCode !== '') {
                    origen = userOrigenCode;
                  }
                } else {
                  isLocked = false;
                }
             ">
          <input type="hidden" name="tipo_itinerario_id" :value="tipo === 'IDA_VUELTA' ? '{{ (index .TiposItinerario 0).ID }}' : '{{ (index .TiposItinerario 1).ID }}'" />
          {{ $idIdaVuelta := "" }} {{ $idSoloIda := "" }} {{ range .TiposItinerario }} {{ if eq .Codigo "IDA_VUELTA" }} {{ $idIdaVuelta = .ID }} {{ end }} {{ if eq .Codigo
          "SOLO_IDA" }} {{ $idSoloIda = .ID }} {{ end }} {{ end }}
          <input type="hidden" name="tipo_itinerario_id" x-bind:value="tipo === 'IDA_VUELTA' ? '{{ $idIdaVuelta }}' : '{{ $idSoloIda }}'" />

          <!-- 1. BLOQUE ITINERARIO -->
          <div class="sm:col-span-6 border-b border-gray-100 pb-4 mb-4">
            <div class="grid grid-cols-6 gap-6">
              <div class="col-span-6 sm:col-span-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Itinerario</label>
                <div class="flex items-center space-x-6">
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" x-model="tipo" value="IDA_VUELTA" class="form-radio h-4 w-4 text-senado-secondary border-gray-300" />
                    <span class="ml-2 text-gray-900 font-medium">Ida y Vuelta</span>
                  </label>
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" x-model="tipo" value="SOLO_IDA" class="form-radio h-4 w-4 text-senado-secondary border-gray-300" />
                    <span class="ml-2 text-gray-900 font-medium">Solo Ida</span>
                  </label>
                </div>
                <p class="text-xs text-gray-500 mt-2" x-show="tipo === 'IDA_VUELTA'">* Ruta fija (Sede <-> Origen).</p>
              </div>

              <div class="col-span-6 sm:col-span-3">
                <label for="aerolinea_sugerida" class="block text-sm font-medium text-gray-700 mb-2">Línea Aérea Sugerida</label>
                <input
                  type="text"
                  name="aerolinea_sugerida"
                  value="{{ .Solicitud.AerolineaSugerida }}"
                  class="shadow-sm focus:ring-senado-secondary block w-full sm:text-sm border-gray-300 rounded-md p-2 border" />
              </div>
            </div>
          </div>

          <!-- 2. BLOQUE ORIGEN / DESTINO -->
          <div class="sm:col-span-3">
            <label for="origen_cod" class="block text-sm font-medium text-gray-700">Lugar de Origen</label>
            <div class="mt-1">
              <select
                name="origen_cod"
                x-model="origen"
                :class="{ 'bg-gray-100 pointer-events-none text-gray-500': isLocked }"
                class="shadow-sm focus:ring-senado-secondary focus:border-senado-secondary block w-full sm:text-sm border-gray-300 rounded-md p-2 border transition-colors">
                {{ if .User.GetOrigenIATA }}
                <option value="{{ .User.GetOrigenIATA }}">{{ if .User.Origen }}{{ .User.Origen.Nombre }}{{ else }}Mi Origen{{ end }} ({{ .User.GetOrigenIATA }})</option>
                {{ end }} {{ if ne .User.GetOrigenIATA "LPB" }}
                <option value="LPB">La Paz - El Alto (LPB)</option>
                {{ end }}
              </select>
            </div>
          </div>

          <div class="sm:col-span-3">
            <label class="block text-sm font-medium text-gray-700">Lugar de Destino</label>
            <div class="mt-1 relative">
              <!-- Input Visual Calculado -->
              <input
                type="text"
                readonly
                class="shadow-sm block w-full sm:text-sm border-gray-300 bg-gray-100 text-gray-600 rounded-md p-2 border cursor-not-allowed font-medium"
                :value="origen === 'LPB' ? (userOrigenName + ' (' + userOrigenCode + ')') : (lpbName + ' (LPB)')" />
              <!-- Input Hidden Real -->
              <input type="hidden" name="destino_cod" :value="origen === 'LPB' ? userOrigenCode : 'LPB'" />

              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Destino automático según origen.</p>
          </div>

          <!-- 3. BLOQUE FECHAS -->
          <div class="sm:col-span-3">
            <label for="fecha_salida" class="block text-sm font-medium text-gray-700">Fecha Salida</label>
            <input
              type="datetime-local"
              name="fecha_salida"
              required
              value="{{ if .Solicitud.FechaIda }}{{ .Solicitud.FechaIda.Format `2006-01-02T15:04` }}{{ end }}"
              class="mt-1 shadow-sm focus:ring-senado-secondary block w-full sm:text-sm border-gray-300 rounded-md p-2 border" />
          </div>

          <div class="sm:col-span-3" x-show="tipo === 'IDA_VUELTA'" x-transition>
            <label for="fecha_retorno" class="block text-sm font-medium text-gray-700">Fecha Retorno</label>
            <input
              type="datetime-local"
              name="fecha_retorno"
              value="{{ if .Solicitud.FechaVuelta }}{{ .Solicitud.FechaVuelta.Format `2006-01-02T15:04` }}{{ end }}"
              class="mt-1 shadow-sm focus:ring-senado-secondary block w-full sm:text-sm border-gray-300 rounded-md p-2 border" />
          </div>
        </div>

        <!-- Motivo -->
        <div class="sm:col-span-6">
          <label for="motivo" class="block text-sm font-medium text-gray-700">Motivo</label>
          <div class="mt-1">
            <textarea id="motivo" name="motivo" rows="3" class="shadow-sm focus:ring-senado-secondary block w-full sm:text-sm border border-gray-300 rounded-md p-2">
{{ .Solicitud.Motivo }}</textarea
            >
          </div>
        </div>
      </div>
    </div>

    <div class="px-4 py-3 bg-gray-50 text-right sm:px-6 flex justify-end">
      <button
        type="submit"
        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-senado-primary hover:bg-senado-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-senado-primary">
        Guardar Cambios
      </button>
    </div>
  </form>
</div>

{{ template "layout_end" . }} {{ end }}
