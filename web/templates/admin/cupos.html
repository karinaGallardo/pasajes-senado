{{ define "admin/cupos.html" }} {{ template "layout_start" . }}

<div class="space-y-6" x-data="{ generating: false, resetting: false, refreshing: false }">
  <!-- Header -->
  <div class="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-gray-100">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Gestión de Cupos</h1>
      <p class="text-gray-500">Administración de cupos mensuales para pasajes por derecho.</p>
    </div>

    <!-- Formulario Generación -->
    <form action="/admin/cupos/generar" method="POST" class="flex gap-2 items-end" @submit="generating = true">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <input type="hidden" name="gestion" value="{{ .Gestion }}" />
      <div class="flex flex-col">
        <label class="block text-xs font-semibold text-gray-700 uppercase">Gestión</label>
        <span class="w-24 border border-gray-200 rounded-md text-sm p-2 bg-gray-100 text-gray-600 font-bold block text-center h-[38px] flex items-center justify-center">
          {{ .Gestion }}
        </span>
      </div>
      <div>
        <label class="block text-xs font-semibold text-gray-700 uppercase">Mes</label>
        <select name="mes" class="border-gray-300 rounded-md text-sm w-32 p-2 bg-gray-50" :disabled="generating">
          {{ range $i, $m := .Meses }} {{ if gt $i 0 }}
          <option value="{{ $i }}" {{ if eq $i $.Mes }}selected{{ end }}>{{ $m }}</option>
          {{ end }} {{ end }}
        </select>
      </div>
      <button
        type="submit"
        class="bg-senado-primary hover:bg-senado-800 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        :disabled="generating">
        <template x-if="generating">
          <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </template>
        <span x-text="generating ? 'Generando...' : 'Generar / Actualizar'"></span>
      </button>
    </form>
  </div>

  <!-- Reset Zone -->
  <div class="flex justify-end">
    <form action="/admin/cupos/reset" method="POST" id="reset-form" @submit="resetting = true">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <input type="hidden" name="gestion" value="{{ .Gestion }}" />
      <input type="hidden" name="mes" value="{{ .Mes }}" />
    </form>

    <button
      type="button"
      @click="window.dispatchEvent(new CustomEvent('open-confirm', { 
        detail: { 
          title: '¿Sincronizar y Corregir Mes?', 
          message: 'Esta acción recalculará las semanas del período, asegurará que todos los senadores tengan su cupo asignado y sincronizará los saldos según el uso real de pasajes. No se eliminará ningún registro.', 
          confirmText: 'Sí, Sincronizar',
          isDanger: false,
          form: document.getElementById('reset-form')
        } 
      }))"
      class="text-senado-secondary hover:text-senado-800 text-xs font-semibold underline disabled:opacity-50"
      :disabled="resetting">
      <span x-text="resetting ? 'Sincronizando...' : 'Sincronizar y Recalcular Mes'"></span>
    </button>
  </div>

  <!-- Filtro / Navegación -->
  <div class="bg-gray-50 p-4 rounded-lg flex gap-4 items-center justify-center border border-gray-200">
    <form action="/admin/cupos" method="GET" class="flex items-center gap-4" @submit="refreshing = true">
      <input type="hidden" name="gestion" value="{{ .Gestion }}" />
      <span class="text-sm font-medium text-gray-700">Visualizando período:</span>
      <span class="px-3 py-1 bg-white border border-gray-300 rounded-md text-sm font-bold text-gray-600">{{ .Gestion }}</span>
      <select name="mes" class="form-select h-9 text-sm rounded-md border-gray-300 w-32" :disabled="refreshing">
        {{ range $i, $m := .Meses }} {{ if gt $i 0 }}
        <option value="{{ $i }}" {{ if eq $i $.Mes }}selected{{ end }}>{{ $m }}</option>
        {{ end }} {{ end }}
      </select>
      <button type="submit" class="text-senado-secondary hover:text-senado-900 font-medium text-sm underline disabled:opacity-50" :disabled="refreshing">
        <span x-text="refreshing ? 'Cargando...' : 'Refrescar Tabla'"></span>
      </button>
    </form>
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">#</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Senador / Usuario</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Semanas</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Usados</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {{ range $i, $cupo := .Cupos }}
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">{{ inc $i }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-bold text-gray-900">{{ .Senador.GetNombreCompleto }}</div>
              <div class="text-xs text-gray-500">
                <span
                  class="px-1 inline-flex text-xxs leading-5 font-semibold rounded-full 
                                {{ if eq .Senador.Tipo `SENADOR_TITULAR` }}bg-purple-100 text-purple-800 {{ end }}
                                {{ if eq .Senador.Tipo `SENADOR_SUPLENTE` }}bg-blue-100 text-blue-800 {{ end }}">
                  {{ .Senador.Tipo }}
                </span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-900">{{ .CupoTotal }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-red-600">{{ .CupoUsado }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-green-600">{{ .Saldo }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button
                @click="openVoucherModal('{{ .ID }}', '{{ .Senador.GetNombreCompleto }}', '{{ .Senador.Tipo }}')"
                class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 px-3 py-1 rounded-md border border-indigo-200 text-xs font-bold transition-all disabled:opacity-50">
                Ver Vouchers
              </button>
            </td>
          </tr>
          {{ else }}
          <tr>
            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
              <div class="flex flex-col items-center justify-center">
                <svg class="w-12 h-12 text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <p>No hay registros de cupos para este período.</p>
                <p class="text-xs mt-1">Utilice el botón "Generar / Actualizar" para calcular los cupos del mes.</p>
              </div>
            </td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pass Go variable to JS -->
<script>
  var globalUsers = [
      {{ range .Users }}
      { id: "{{ .ID }}", name: "{{ .GetNombreCompleto }}", tipo: "{{ .Tipo }}" },
      {{ end }}
  ];
</script>

<!-- Transfer Modal -->
<div
  x-data="{ 
        open: false, 
        voucherId: '', 
        ownerName: '', 
        semana: '', 
        candidates: globalUsers, 
        selectedCandidate: '' 
     }"
  @open-transfer-modal.window="
        open = true; 
        voucherId = $event.detail.id; 
        ownerName = $event.detail.name; 
        semana = $event.detail.semana;
        let suplente = $event.detail.suplente;
        let ownerType = $event.detail.ownerType;
        
        if (ownerType === 'SENADOR_TITULAR') {
            if (suplente) {
                candidates = [{ id: suplente.ID, name: suplente.Firstname + ' ' + suplente.Lastname, tipo: suplente.Tipo }];
                selectedCandidate = suplente.ID;
            } else {
                candidates = [];
                selectedCandidate = '';
            }
        } else {
            // For other users, we might allow transfer to anyone (or handle differently)
            candidates = globalUsers;
            selectedCandidate = '';
        }
     "
  x-show="open"
  class="fixed z-20 inset-0 overflow-y-auto"
  style="display: none"
  x-cloak>
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div x-show="open" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="open = false"></div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div
      class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
      <form action="/admin/cupos/transferir" method="POST">
        <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
        <input type="hidden" name="voucher_id" :value="voucherId" />
        <input type="hidden" name="gestion" value="{{ .Gestion }}" />
        <input type="hidden" name="mes" value="{{ .Mes }}" />

        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Transferir Pasaje</h3>
        <p class="text-sm text-gray-500 mb-4">
          De:
          <strong x-text="ownerName"></strong>
          -
          <strong x-text="semana"></strong>
        </p>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Destinatario</label>

          <template x-if="candidates.length === 1">
            <div class="mt-1 p-3 bg-indigo-50 border border-indigo-100 rounded-md ring-1 ring-indigo-200">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-indigo-500 font-bold uppercase tracking-wider mb-0.5">Transferencia Permitida a:</div>
                  <div class="text-sm font-black text-indigo-900" x-text="candidates[0].name"></div>
                  <div class="text-[10px] text-indigo-400 font-bold flex items-center gap-1">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    <span x-text="candidates[0].tipo"></span>
                  </div>
                </div>
                <div class="bg-indigo-600 p-1.5 rounded-lg shadow-sm">
                  <svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </div>
              </div>
              <input type="hidden" name="destino_id" :value="candidates[0].id" />
            </div>
          </template>

          <template x-if="candidates.length > 1">
            <select
              name="destino_id"
              x-model="selectedCandidate"
              required
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
              <option value="">-- Seleccionar Destinatario --</option>
              <template x-for="user in candidates" :key="user.id">
                <option :value="user.id" x-text="user.name + ' (' + user.tipo + ')'"></option>
              </template>
            </select>
          </template>

          <template x-if="candidates.length === 0">
            <div class="mt-1 p-3 bg-red-50 border border-red-100 rounded-md flex items-center gap-2">
              <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
              <span class="text-xs text-red-600 font-bold">No se encontró un suplente habilitado para este senador.</span>
            </div>
          </template>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Motivo</label>
          <input type="text" name="motivo" required class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2" />
        </div>
        <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense" x-data="{ submittingTransfer: false }">
          <button
            type="submit"
            @click="submittingTransfer = true"
            :disabled="submittingTransfer || candidates.length === 0"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:col-start-2 sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed items-center gap-2">
            <template x-if="submittingTransfer">
              <svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </template>
            <span x-text="submittingTransfer ? 'Procesando...' : 'Confirmar'"></span>
          </button>
          <button
            type="button"
            @click="open = false"
            :disabled="submittingTransfer"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:col-start-1 sm:text-sm">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Vouchers List Modal -->
<div
  x-data="{ open: false, cupoId: '', userName: '', ownerType: '', vouchers: [], currentSuplente: null, loading: false }"
  @open-voucher-modal.window="
        open = true; 
        cupoId = $event.detail.id; 
        userName = $event.detail.name; 
        ownerType = $event.detail.type;
        loading = true;
        currentSuplente = null; 
        fetch('/admin/cupos/' + cupoId + '/vouchers')
            .then(response => response.json())
            .then(data => { 
                vouchers = data.vouchers; 
                currentSuplente = data.suplente;
                loading = false; 
            })
            .catch(error => { console.error('Error:', error); loading = false; });
     "
  x-show="open"
  class="fixed z-10 inset-0 overflow-y-auto"
  style="display: none"
  x-cloak>
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div x-show="open" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="open = false"></div>

    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Detalle de Vouchers -
              <span x-text="userName"></span>
            </h3>
            <!-- Suplente Info -->
            <div x-show="currentSuplente" class="text-sm text-blue-600 mb-2 font-semibold">
              Suplente Habilitado:
              <span x-text="currentSuplente ? (currentSuplente.Firstname + ' ' + currentSuplente.Lastname) : 'Ninguno'"></span>
            </div>
            <div class="mt-4 border-t border-gray-100 pt-4">
              <div x-show="loading" class="text-center py-4 text-gray-500">Cargando vouchers...</div>
              <div x-show="!loading">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Semana</th>
                      <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Estado</th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Detalle Transferencia</th>
                      <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    <template x-for="v in vouchers" :key="v.ID">
                      <tr>
                        <td class="px-4 py-3 whitespace-nowrap">
                          <div class="text-sm font-bold text-gray-700" x-text="v.Semana"></div>
                          <div class="text-[10px] text-gray-400 font-medium" x-show="v.FechaDesde && v.FechaHasta">
                            Validez:
                            <span x-text="new Date(v.FechaDesde).toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit'})"></span>
                            -
                            <span x-text="new Date(v.FechaHasta).toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit'})"></span>
                          </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center">
                          <span
                            class="px-2 py-1 text-xs font-bold rounded-md"
                            :class="{
                                                'bg-green-100 text-green-800': v.Estado === 'DISPONIBLE',
                                                'bg-gray-100 text-gray-800': v.Estado === 'USADO',
                                                'bg-yellow-100 text-yellow-800': v.Estado !== 'DISPONIBLE' && v.Estado !== 'USADO'
                                              }"
                            x-text="v.Estado"></span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                          <template x-if="v.EsTransferido">
                            <div>
                              <span class="text-xs text-orange-600 font-bold block">TRANSFERIDO</span>
                              <div class="text-[11px] font-medium text-gray-700 mt-0.5" x-show="v.Beneficiario">
                                A:
                                <span x-text="v.Beneficiario.Firstname + ' ' + v.Beneficiario.Lastname"></span>
                              </div>
                              <span class="text-[10px] italic text-gray-400" x-show="v.MotivoTransfer">
                                ("
                                <span x-text="v.MotivoTransfer"></span>
                                ")
                              </span>
                            </div>
                          </template>
                          <span x-show="!v.EsTransferido">-</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm">
                          <button
                            x-show="v.Estado === 'DISPONIBLE'"
                            @click="openTransferModal(v.ID, userName, v.Semana, currentSuplente, ownerType)"
                            class="text-indigo-600 hover:text-indigo-900 font-medium disabled:opacity-50">
                            Transferir
                          </button>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button
          type="button"
          @click="open = false"
          class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function openVoucherModal(id, name, type) {
    window.dispatchEvent(
      new CustomEvent("open-voucher-modal", {
        detail: { id: id, name: name, type: type },
      })
    );
  }
  function openTransferModal(id, name, semana, suplente, ownerType) {
    window.dispatchEvent(
      new CustomEvent("open-transfer-modal", {
        detail: { id: id, name: name, semana: semana, suplente: suplente, ownerType: ownerType },
      })
    );
  }
</script>

{{ template "layout_end" . }} {{ end }}
